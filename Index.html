<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>CC HAIR ORDER APP v2</title>

  <!-- ZXing 바코드 스캔 라이브러리 (더 강력하고 모바일 최적화) -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

  <style>
    /* Google Fonts 추가 - iOS 느낌의 깔끔한 폰트 */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(at 0% 0%, #E0E7FF 0px, transparent 50%),
        radial-gradient(at 50% 0%, #FDF2F8 0px, transparent 50%),
        radial-gradient(at 100% 0%, #FFFBEB 0px, transparent 50%),
        radial-gradient(at 50% 50%, #F0F9FF 0px, transparent 50%),
        #F2F2F7;
      min-height: 100vh;
      padding: 0;
      transition: background 0.8s ease-in-out;
      overflow-x: hidden;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    /* 회사별 오로라 배경 테마 */
    body.theme-outre {
      background: radial-gradient(at 0% 0%, #FFF7ED 0px, transparent 50%),
        radial-gradient(at 50% 0%, #FFEDD5 0px, transparent 50%),
        radial-gradient(at 100% 0%, #FEF3C7 0px, transparent 50%),
        radial-gradient(at 50% 50%, #FFFBEB 0px, transparent 50%),
        #FFF2E6;
    }

    body.theme-sng {
      background: radial-gradient(at 0% 0%, #EFF6FF 0px, transparent 50%),
        radial-gradient(at 50% 0%, #DBEAFE 0px, transparent 50%),
        radial-gradient(at 100% 0%, #E0E7FF 0px, transparent 50%),
        radial-gradient(at 50% 50%, #F0F4FF 0px, transparent 50%),
        #F0F4FF;
    }

    .header.theme-outre {
      border-bottom: 2px solid #FF8C00;
    }

    .header.theme-sng {
      border-bottom: 2px solid #007AFF;
    }

    .container {
      max-width: 600px;
      width: 100%;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      min-height: 100vh;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* ===== 헤더 ===== */
    .header {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      color: #000;
      padding: 30px 20px 20px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .estimated-price {
      font-size: 16px;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 8px;
      border: 2px solid;
      display: none; /* 기본적으로 숨김 */
    }

    .estimated-price.visible {
      display: block;
    }

    .estimated-price.outre {
      color: #FF8C00;
      background: rgba(255, 140, 0, 0.1);
      border-color: #FF8C00;
    }

    .estimated-price.sng {
      color: #4169E1;
      background: rgba(65, 105, 225, 0.1);
      border-color: #4169E1;
    }

    .estimated-price-results {
      font-size: 18px;
      font-weight: 700;
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px solid;
      margin-top: 10px;
      text-align: center;
      display: none; /* 기본적으로 숨김 */
    }

    .estimated-price-results.visible {
      display: block;
    }

    .estimated-price-results.outre {
      color: #FF8C00;
      background: rgba(255, 140, 0, 0.1);
      border-color: #FF8C00;
    }

    .estimated-price-results.sng {
      color: #4169E1;
      background: rgba(65, 105, 225, 0.1);
      border-color: #4169E1;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin: 0;
    }

    .order-complete-header-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      background: #007AFF; /* Default to SNG blue */
      color: white;
      border: none;
      border-radius: 22px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .order-complete-header-btn.theme-outre {
      background: #FF8C00;
    }

    .order-complete-header-btn.theme-sng {
      background: #007AFF;
    }

    .order-complete-header-btn:active {
      transform: translateY(-50%) scale(0.92);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .content {
      padding: 20px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* ===== 바코드 입력 섹션 (Option 3 iOS 스타일) ===== */
    #inputSection {
      display: block;
      padding: 20px 15px;
    }

    .search-group {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 4px;
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .search-group:focus-within {
      background: rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
    }

    #barcodeDisplay {
      flex: 1;
      height: 50px;
      background: transparent;
      border: none;
      padding: 0 15px;
      font-size: 17px;
      font-weight: 500;
      color: #000;
      outline: none;
      width: 100%;
    }

    #barcodeDisplay::placeholder {
      color: #8E8E93;
    }

    .search-action-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      color: #007AFF;
      /* iOS System Blue */
      transition: background 0.2s;
    }

    .search-action-btn:active {
      background: rgba(0, 122, 255, 0.1);
      transform: scale(0.92);
    }

    .main-buttons-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 30px;
    }

    .ios-btn {
      height: 110px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.04);
    }

    .ios-btn.primary {
      background: rgba(0, 122, 255, 0.9);
      color: white;
      border: none;
    }

    .ios-btn.primary.theme-outre {
      background: rgba(255, 140, 0, 0.9);
    }

    .ios-btn.primary.theme-sng {
      background: #007AFF;
    }

    .ios-btn.secondary {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      color: #000;
    }

    .ios-btn.secondary.active {
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
    }

    .ios-btn:active {
      transform: scale(0.92) translateY(2px);
      opacity: 0.8;
    }

    .ios-btn .btn-icon {
      font-size: 28px;
    }

    .camera-btn {
      height: 60px;
      padding: 0 20px;
      background: linear-gradient(135deg, #FFB6C1 0%, #FF69B4 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      transition: background 0.3s;
    }

    .camera-btn.theme-outre {
      background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
    }

    .camera-btn.theme-sng {
      background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);
    }

    .camera-btn:active {
      transform: scale(0.98);
    }

    .keyboard-btn {
      height: 60px;
      padding: 0 18px;
      background: linear-gradient(135deg, #6C757D 0%, #495057 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      transition: background 0.3s, transform 0.2s;
    }

    .keyboard-btn.active {
      background: linear-gradient(135deg, #343A40 0%, #212529 100%);
    }

    .keyboard-btn:active {
      transform: scale(0.98);
    }

    .search-btn {
      width: auto;
      height: 60px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #2D9CDB 0%, #1C7ED6 100%);
      color: white;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.12);
      padding: 0 16px;
      min-width: 72px;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .search-btn:active {
      transform: scale(0.98);
    }

    /* ===== 숫자 키패드 ===== */
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .key-btn {
      height: 60px;
      font-size: 24px;
      font-weight: 700;
      background: white;
      border: 2px solid #FFB6C1;
      border-radius: 12px;
      color: #FFB6C1;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      user-select: none;
      transition: border-color 0.3s, color 0.3s, background 0.3s;
    }

    .key-btn.theme-outre {
      border-color: #FF8C00;
      color: #FF8C00;
    }

    .key-btn.theme-sng {
      border-color: #4169E1;
      color: #4169E1;
    }

    .key-btn:active {
      transform: scale(0.95);
      background: #FFF8F0;
    }

    .key-btn.delete {
      background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
      color: white;
      border: none;
    }

    /* ===== 최근 검색 / 즐겨찾기 ===== */
    .quick-section {
      margin-top: 10px;
      margin-bottom: 15px;
    }

    .quick-header {
      font-size: 14px;
      font-weight: 700;
      color: #555;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .quick-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .quick-item {
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .quick-item:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .quick-item .company-pill {
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
    }

    .company-pill.outre {
      background: rgba(255, 140, 0, 0.12);
      color: #FF8C00;
      border: 1px solid rgba(255, 140, 0, 0.3);
    }

    .company-pill.sng {
      background: rgba(65, 105, 225, 0.12);
      color: #4169E1;
      border: 1px solid rgba(65, 105, 225, 0.3);
    }

    .quick-empty {
      font-size: 12px;
      color: #888;
    }

    /* ===== 카메라 모달 ===== */
    #cameraModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 9999;
    }

    #cameraModal.active {
      display: flex;
      flex-direction: column;
    }

    .camera-header {
      background: rgba(255, 182, 193, 0.95);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      transition: background 0.3s;
    }

    .camera-header.theme-outre {
      background: rgba(255, 140, 0, 0.95);
    }

    .camera-header.theme-sng {
      background: rgba(65, 105, 225, 0.95);
    }

    .camera-viewport {
      flex: 1;
      position: relative;
      background: black;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #canvas {
      display: none;
    }

    /* 스캔 가이드 박스 */
    .scan-guide {
      position: absolute;
      width: 80%;
      max-width: 300px;
      height: 150px;
      border: 3px solid #00FF00;
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        border-color: #00FF00;
      }

      50% {
        border-color: #00CC00;
      }
    }

    /* 스캔 안내 텍스트 */
    .scan-tip {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      pointer-events: none;
      max-width: 90%;
    }

    .camera-footer {
      padding: 20px;
      background: rgba(0, 0, 0, 0.9);
    }

    .close-camera-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
    }

    .close-camera-btn:active {
      transform: scale(0.98);
    }

    /* ===== 로딩 ===== */
    #loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FFB6C1;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      transition: border-top-color 0.3s;
    }

    .spinner.theme-outre {
      border-top-color: #FF8C00;
    }

    .spinner.theme-sng {
      border-top-color: #4169E1;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      font-size: 18px;
      color: #FFB6C1;
      font-weight: 600;
      transition: color 0.3s;
    }

    .loading-text.theme-outre {
      color: #FF8C00;
    }

    .loading-text.theme-sng {
      color: #4169E1;
    }

    /* ===== 결과 섹션 ===== */
    #resultsSection {
      display: none;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      overflow: hidden;
    }

    /* ===== 키워드 검색 결과 섹션 ===== */
    #keywordResultsSection {
      display: none;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      overflow: hidden;
    }

    .keyword-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .keyword-back-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background: #f0f0f0;
      font-weight: 700;
      cursor: pointer;
    }

    .keyword-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }

    .keyword-meta {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }

    .keyword-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .keyword-tab {
      flex: 1;
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      background: #f5f5f5;
      font-weight: 700;
      cursor: pointer;
      color: #666;
    }

    .keyword-tab.active {
      background: #333;
      color: white;
    }

    .keyword-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .keyword-filter {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 12px;
      font-weight: 700;
      color: #555;
      cursor: pointer;
      background: white;
    }

    .keyword-filter.active {
      background: #2D9CDB;
      color: white;
      border-color: #2D9CDB;
    }

    .keyword-breakdown-inline {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .keyword-breakdown-label {
      font-size: 12px;
      font-weight: 700;
      color: #666;
      margin-bottom: 4px;
    }

    .keyword-breakdown-buttons-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .keyword-btn-inline {
      padding: 6px 12px;
      background: white;
      border: 2px solid #2D9CDB;
      color: #2D9CDB;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .keyword-btn-inline.selected {
      background: #2D9CDB;
      color: white;
    }

    .keyword-btn-inline:active {
      transform: scale(0.95);
    }

    .keyword-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
      flex: 1;
      padding-right: 2px;
    }

    .keyword-item {
      padding: 12px 14px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #E5E5EA;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .keyword-desc {
      font-weight: 700;
      font-size: 14px;
      color: #333;
      flex: 1;
      word-break: break-word;
    }

    .keyword-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .keyword-status {
      font-size: 11px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 10px;
      background: #f1f3f5;
      color: #555;
    }

    .favorite-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
    }

    .keyword-empty {
      text-align: center;
      color: #777;
      padding: 30px 10px;
      font-size: 14px;
    }

    .text-shipped {
      color: magenta;
      font-weight: 700;
    }

    /* 키워드 하이라이트 */
    .keyword-highlight {
      color: #FF0000;
      font-weight: 700;
    }

    /* 회사 구분자 */
    .keyword-company-divider {
      font-size: 13px;
      font-weight: 700;
      padding: 10px 14px;
      margin: 8px 0 4px 0;
      border-radius: 8px;
      text-align: center;
    }

    .keyword-company-divider.outre {
      background: rgba(255, 140, 0, 0.15);
      color: #FF8C00;
      border: 1px solid rgba(255, 140, 0, 0.3);
    }

    .keyword-company-divider.sng {
      background: rgba(65, 105, 225, 0.15);
      color: #4169E1;
      border: 1px solid rgba(65, 105, 225, 0.3);
    }

    .results-summary {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .results-item-name {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      line-height: 1.2;
      word-break: break-word;
      flex: 1;
      min-width: 0;
    }

    .results-side {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex-shrink: 0;
    }

    .results-side-top {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .results-side-bottom {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
    }

    .results-company-badge {
      flex-shrink: 0;
    }

    /* 상단 액션 버튼 (4개 나란히) - 재구성 */
    .action-buttons-top {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn-top {
      height: 70px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
      user-select: none;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      padding: 6px;
      line-height: 1.2;
    }

    /* Primary: 저장 후 카메라 (가장 큰/강조) */
    .action-btn-top.save-camera {
      background: linear-gradient(135deg, #007AFF 0%, #0056B3 100%);
    }

    .action-btn-top.save-camera .btn-icon {
      font-size: 22px;
      margin-bottom: 2px;
    }

    .action-btn-top.save-camera .btn-label {
      font-size: 11px;
      font-weight: 600;
    }

    /* Secondary: 저장 후 검색창 */
    .action-btn-top.save-back {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      color: #333;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .action-btn-top.save-back .btn-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }

    .action-btn-top.save-back .btn-label {
      font-size: 10px;
      font-weight: 600;
    }

    /* Tertiary: 검색창으로 돌아가기 (저장 없이) */
    .action-btn-top.cancel {
      background: rgba(142, 142, 147, 0.2);
      backdrop-filter: blur(10px);
      color: #333;
    }

    .action-btn-top.cancel .btn-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }

    .action-btn-top.cancel .btn-label {
      font-size: 10px;
      font-weight: 600;
    }

    /* Cart: 장바구니 */
    .action-btn-top.cart {
      background: #FF9500;
    }

    /* 새로운 큰 버튼 스타일들 */
    .action-btn-top .btn-icon {
      font-size: 28px;
    }

    .action-btn-top .btn-label {
      font-size: 12px;
      font-weight: 600;
    }

    .camera-btn-large {
      background: linear-gradient(135deg, #FF6B9D 0%, #FF4D88 100%);
    }

    .keyboard-btn-large {
      background: linear-gradient(135deg, #6C757D 0%, #495057 100%);
    }

    .keyword-btn-large {
      background: linear-gradient(135deg, #2D9CDB 0%, #1C7ED6 100%);
    }

    .cart-btn-large {
      background: linear-gradient(135deg, #FF9500 0%, #FF8000 100%);
    }

    .action-btn-top:active {
      transform: scale(0.95);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .favorite-btn-results {
      border: none;
      background: transparent;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      margin: 0;
      flex-shrink: 0;
    }

    .results-header {
      display: none;
    }

    .order-complete-btn {
      display: none;
    }

    /* ===== 수량 조절 버튼 (2줄 레이아웃) ===== */
    .quantity-controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .qty-btn {
      height: 40px;
      font-size: 16px;
      font-weight: 700;
      background: linear-gradient(135deg, #F6BCCB 0%, #F2A7BC 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      user-select: none;
      transition: all 0.2s;
    }

    .qty-btn.theme-outre {
      background: linear-gradient(135deg, #6ACF8C 0%, #4FB978 100%);
    }

    .qty-btn.theme-sng {
      background: linear-gradient(135deg, #B09AD8 0%, #9A86C9 100%);
    }

    .qty-btn:active {
      transform: scale(0.95);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    .qty-btn.clear {
      background: linear-gradient(135deg, #E85D5D 0%, #D44545 100%);
    }

    .qty-btn.all-toggle.active {
      background: linear-gradient(135deg, #4A4A4A 0%, #666666 100%);
    }

    .qty-spacer {
      /* 빈 공간 (나중 확장용) */
    }

    .results-fixed {
      flex: 0 0 auto;
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
      padding-bottom: 8px;
    }

    /* ===== 제품 테이블 ===== */
    .table-container {
      overflow-x: hidden;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      max-height: none;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }

    .products-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }

    .products-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .products-table th {
      position: sticky;
      top: 0;
      z-index: 11;
    }

    .products-table th {
      background: linear-gradient(135deg, #F6BCCB 0%, #F2A7BC 100%);
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
      transition: background 0.3s;
    }

    .products-table.theme-outre th {
      background: linear-gradient(135deg, #FFB08C 0%, #FFA070 100%);
    }

    .products-table.theme-sng th {
      background: linear-gradient(135deg, #7AA1EA 0%, #6A92DD 100%);
    }

    .products-table td {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 16px;
      vertical-align: middle;
      line-height: 1.2;
    }

    .products-table th.qty-col,
    .products-table td.qty-col {
      width: 70px;
    }

    .products-table th.color-col,
    .products-table td.color-col {
      width: 90px;
    }

    .products-table th.shipped-col,
    .products-table td.shipped-col {
      width: 70px;
      text-align: right;
    }

    .products-table th.price-col,
    .products-table td.price-col {
      width: 100px;
      text-align: right;
      white-space: normal;
      word-break: break-word;
      vertical-align: top;
    }

    .price-text {
      white-space: normal;
      word-break: break-word;
      line-height: 1.4;
    }

    .color-shipped {
      color: magenta;
      font-weight: 700;
    }

    .color-backorder {
      color: green;
      font-weight: 700;
    }

    .products-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .products-table tbody tr:hover {
      background-color: #FFF8F0;
    }

    .products-table tbody tr.group-header-row {
      cursor: default;
      background-color: #F5E6D3;
    }

    .products-table tbody tr.group-header-row:hover {
      background-color: #F5E6D3;
    }

    .group-header-cell {
      font-weight: 700;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .products-table tbody tr.selected {
      background-color: #FFF1E6 !important;
      border-left: 4px solid #FFB6C1;
      transition: border-left-color 0.3s;
    }

    .products-table.theme-outre tbody tr.selected {
      border-left-color: #FF8C00;
    }

    .products-table.theme-sng tbody tr.selected {
      border-left-color: #4169E1;
    }

    .quantity-input {
      width: 80px;
      height: 45px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      border: 2px solid #FFB6C1;
      border-radius: 8px;
      background: white;
      color: #FFB6C1;
      cursor: pointer;
      outline: none !important;
      transition: border-color 0.3s, color 0.3s;
    }

    .quantity-input.theme-outre {
      border-color: #FF8C00;
      color: #FF8C00;
    }

    .quantity-input.theme-sng {
      border-color: #4169E1;
      color: #4169E1;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* 회사 뱃지 - 미니멀 */
    .company-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
    }

    .company-badge.outre {
      background: rgba(255, 140, 0, 0.12);
      color: #FF8C00;
      border: 1px solid rgba(255, 140, 0, 0.3);
    }

    .company-badge.sng {
      background: rgba(65, 105, 225, 0.12);
      color: #4169E1;
      border: 1px solid rgba(65, 105, 225, 0.3);
    }

    /* 주문 페이지 이동 버튼 */
    .goto-order-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #4169E1 0%, #6495ED 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .goto-order-btn:active {
      transform: scale(0.95);
    }

    /* ===== 액션 버튼 ===== */
    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      user-select: none;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn.add {
      background: linear-gradient(135deg, #FFB6C1 0%, #FF69B4 100%);
      color: white;
    }

    .action-btn.add.theme-outre {
      background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
    }

    .action-btn.add.theme-sng {
      background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);
    }

    .action-btn.save-camera {
      background: linear-gradient(135deg, #4169E1 0%, #6495ED 100%);
      color: white;
    }

    .action-btn.save-back {
      background: linear-gradient(135deg, #808080 0%, #696969 100%);
      color: white;
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    /* ===== 백오더 프롬프트 모달 ===== */
    #backorderModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10001;
      overflow: auto;
    }

    #backorderModal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .backorder-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .backorder-modal-header {
      background: linear-gradient(135deg, #28a745 0%, #5cb85c 100%);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
    }

    .backorder-modal-body {
      padding: 30px 20px;
      text-align: center;
    }

    .backorder-modal-message {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 25px;
      color: #333;
    }

    .backorder-modal-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .backorder-btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .backorder-btn:active {
      transform: scale(0.98);
    }

    .backorder-btn.yes {
      background: linear-gradient(135deg, #28a745 0%, #5cb85c 100%);
      color: white;
    }

    .backorder-btn.no {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }

    .backorder-remember {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }

    .backorder-remember input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .backorder-remember label {
      font-size: 14px;
      color: #666;
      cursor: pointer;
    }

    /* ===== ORDER COMPLETE 모달 ===== */
    #orderModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      overflow: auto;
    }

    #orderModal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .order-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .order-modal-header {
      background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);
      color: white;
      padding: 20px;
      border-radius: 16px 16px 0 0;
      font-size: 22px;
      font-weight: 700;
      text-align: center;
    }

    /* 회사 탭 */
    .company-tabs {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #ddd;
      align-items: center;
    }

    .company-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: #f5f5f5;
      color: #999;
      border: none;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .company-tab:hover {
      background: #e8e8e8;
    }

    .company-tab.active {
      background: white;
      color: #333;
      border-bottom: 3px solid #FF8C00;
    }

    .company-tab.active.tab-outre {
      border-bottom-color: #FF8C00;
    }

    .company-tab.active.tab-sng {
      border-bottom-color: #4169E1;
    }

    .company-tab .tab-amount {
      margin-left: 8px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }

    .company-tab.tab-sng .tab-amount {
      color: #4169E1;
    }

    .company-tab.tab-outre .tab-amount {
      color: #FF8C00;
    }

    .order-modal-body {
      flex: 1;
      overflow: auto;
      padding: 20px;
    }

    .order-table-container {
      overflow-x: hidden;
      margin-bottom: 20px;
    }

    .order-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .order-table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #ddd;
    }

    .order-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .order-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .order-row {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #eee;
    }

    .order-row-content {
      display: grid;
      grid-template-columns: 1.6fr 0.8fr 0.6fr;
      gap: 8px;
      padding: 12px;
      align-items: center;
      transition: transform 0.2s ease-out;
      background: #fff;
      position: relative;
      z-index: 1;
    }

    .order-row-header .order-row-content {
      background: #f5f5f5;
      font-weight: 700;
      color: #333;
    }

    .order-row-cell {
      font-size: 14px;
      color: #333;
      word-break: break-word;
    }

    .order-row.swiped .order-row-content {
      transform: translateX(-80px);
    }

    .order-row-delete {
      position: absolute;
      right: -80px;
      top: 0;
      width: 80px;
      height: 100%;
      border: none;
      background: #DC143C;
      color: white;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: right 0.2s ease-out;
      z-index: 2;
    }

    .order-row.swiped .order-row-delete {
      right: 0;
    }

    .empty-message {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .order-modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .modal-btn {
      flex: 1;
      min-width: 120px;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
    }

    .modal-btn:active {
      transform: scale(0.98);
    }

    .modal-btn.copy {
      background: linear-gradient(135deg, #4169E1 0%, #6495ED 100%);
      color: white;
    }

    .modal-btn.clear-list {
      background: linear-gradient(135deg, #DC143C 0%, #B22222 100%);
      color: white;
    }

    .modal-btn.close {
      background: linear-gradient(135deg, #808080 0%, #696969 100%);
      color: white;
    }

    /* ===== 키워드 분석 모달 ===== */
    #keywordBreakdownModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10002;
      overflow: auto;
    }

    #keywordBreakdownModal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .keyword-breakdown-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .keyword-breakdown-header {
      background: linear-gradient(135deg, #2D9CDB 0%, #1C7ED6 100%);
      color: white;
      padding: 20px;
      border-radius: 16px 16px 0 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .keyword-breakdown-back {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .keyword-breakdown-back:active {
      background: rgba(255, 255, 255, 0.3);
    }

    .keyword-breakdown-title {
      font-size: 18px;
      font-weight: 700;
    }

    .keyword-breakdown-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .keyword-breakdown-product {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }

    .keyword-breakdown-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .keyword-btn-item {
      padding: 10px 16px;
      background: white;
      border: 2px solid #2D9CDB;
      color: #2D9CDB;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .keyword-btn-item:hover {
      background: #e3f2fd;
    }

    .keyword-btn-item.selected {
      background: #2D9CDB;
      color: white;
    }

    .keyword-breakdown-selected {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      min-height: 60px;
    }

    .selected-label {
      font-size: 12px;
      font-weight: 700;
      color: #666;
      margin-bottom: 8px;
    }

    .selected-keywords {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .keyword-breakdown-search {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #2D9CDB 0%, #1C7ED6 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .keyword-breakdown-search:active {
      transform: scale(0.98);
    }

    /* ===== 알림 ===== */
    #alertMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      z-index: 20000;
      display: none;
      max-width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    #alertMessage.show {
      display: block;
      animation: fadeInOut 3s;
    }

    #quantityFlash {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.6);
      opacity: 0;
      pointer-events: none;
      font-size: 72px;
      font-weight: 800;
      color: #333;
      text-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      z-index: 20001;
    }

    #quantityFlash.show {
      animation: quantityFlash 0.8s ease-out;
    }

    @keyframes fadeInOut {

      0%,
      100% {
        opacity: 0;
      }

      10%,
      90% {
        opacity: 1;
      }
    }

    @keyframes quantityFlash {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.6);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.1);
      }
    }

    /* ===== 반응형 ===== */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 18px;
      }

      .order-complete-header-btn {
        font-size: 12px;
        padding: 6px 12px;
      }

      .quantity-controls {
        grid-template-columns: repeat(4, 1fr);
      }

      .qty-btn {
        height: 38px;
        font-size: 14px;
      }

      .products-table th,
      .products-table td {
        padding: 10px;
        font-size: 14px;
      }

      .quantity-input {
        width: 60px;
        height: 40px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .barcode-container {
        gap: 6px;
      }

      .camera-btn,
      .keyboard-btn,
      .search-btn {
        font-size: 13px;
        padding: 0 12px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .order-modal-footer {
        flex-direction: column;
      }

      .modal-btn {
        width: 100%;
      }
    }

    @media (max-width: 360px) {
      .quantity-controls {
        gap: 6px;
      }

      .qty-btn {
        height: 34px;
        font-size: 12px;
        border-radius: 6px;
      }
    }

    /* ============================================================================ */
    /* 상태 관리 UI - 컬러 통계 & 상태 배지 */
    /* ============================================================================ */

    /* 컬러 통계 컨테이너 (고정 위치) */
    #color-stats-container {
      display: none;
      margin: 15px 0;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      border: 2px solid #dee2e6;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #color-stats-container.visible {
      display: block;
    }

    .stats-title {
      font-weight: 700;
      font-size: 16px;
      color: #495057;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stats-title::before {
      content: '';
      font-size: 18px;
    }

    #color-stats-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .stat-item {
      flex: 1;
      min-width: 100px;
      padding: 10px 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
      display: block;
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 5px;
    }

    .stat-value {
      display: block;
      font-weight: 700;
      font-size: 20px;
      color: #212529;
    }

    /* 상태별 배지 */
    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      margin-left: 8px;
      font-size: 11px;
      font-weight: 700;
      border-radius: 12px;
      vertical-align: middle;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .badge-new {
      background-color: #4CAF50;
      color: white;
    }

    .badge-discontinue-unknown {
      background-color: #FFF9C4;
      color: #F57C00;
      border: 1px solid #FFB300;
    }

    .badge-discontinued {
      background-color: #E0E0E0;
      color: #757575;
      border: 1px solid #BDBDBD;
    }

    /* 상태별 행 스타일 */
    .status-new {
      /* 기본 스타일 유지 */
    }

    .status-active {
      /* 기본 스타일 유지 */
    }

    .status-discontinue-unknown {
      /* 기본 스타일 유지 */
    }

    .status-discontinued {
      background-color: #E0E0E0 !important;
    }

    .status-discontinued input[type="number"] {
      background-color: #f5f5f5 !important;
      cursor: not-allowed !important;
      color: #999 !important;
    }

    .input-disabled-label {
      display: block;
      font-size: 11px;
      color: #999;
      margin-top: 3px;
      text-align: center;
    }

    /* 반응형: 모바일에서 통계 항목 크기 조정 */
    @media (max-width: 600px) {
      .stat-item {
        min-width: 70px;
        padding: 8px 10px;
      }

      .stat-value {
        font-size: 18px;
      }

      .status-badge {
        font-size: 10px;
        padding: 2px 8px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>CC HAIR ORDER APP v2</h1>
      <div class="header-right">
        <div id="estimatedPrice" class="estimated-price">$0.00</div>
        <button class="order-complete-header-btn" onclick="app.showOrderComplete()">🛒</button>
      </div>
    </div>

    <div class="content">
      <!-- 바코드 입력 섹션 -->
      <div id="inputSection">
        <div class="search-group">
          <input type="text" id="barcodeDisplay" maxlength="50" inputmode="none" readonly
            placeholder="Enter barcode or item name">
          <button class="search-action-btn" onclick="app.clearBarcode()" id="clearBtn" style="display: none;">✕</button>
          <button class="search-action-btn" onclick="app.searchFromKeyboard()">🔍</button>
        </div>

        <div class="main-buttons-grid">
          <button class="ios-btn primary" onclick="app.openCamera()">
            <span class="btn-icon">📷</span>
            <span>Scan Barcode</span>
          </button>
          <button class="ios-btn secondary keyboard-btn" onclick="app.toggleKeyboardMode()">
            <span class="btn-icon">⌨️</span>
            <span>Keyboard</span>
          </button>
        </div>

        <div class="quick-section">
          <div class="quick-header">Favorites</div>
          <div id="favoritesList" class="quick-list"></div>
          <div id="favoritesEmpty" class="quick-empty">No favorites</div>
        </div>

        <div class="quick-section">
          <div class="quick-header">Recent searches/scans</div>
          <div id="historyList" class="quick-list"></div>
          <div id="historyEmpty" class="quick-empty">No recent items</div>
        </div>
      </div>

      <!-- 로딩 -->
      <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Searching...</div>
      </div>

      <!-- 결과 섹션 -->
      <div id="resultsSection">
        <div class="results-fixed">
          <div class="results-summary" id="keywordBackRow" style="display: none;">
            <button class="keyword-back-btn" onclick="app.backToKeywordResults()">Back to results</button>
          </div>

          <div class="action-buttons-top">
            <button class="action-btn-top camera-btn-large" onclick="app.openCamera()">
              <span class="btn-icon">📷</span>
              <span class="btn-label">CAMERA</span>
            </button>
            <button class="action-btn-top keyboard-btn-large" onclick="app.cancelToSearch()">
              <span class="btn-icon">⌨️</span>
              <span class="btn-label">KEYBOARD</span>
            </button>
            <button class="action-btn-top keyword-btn-large" onclick="app.showKeywordBreakdown()">
              <span class="btn-icon">🔍</span>
              <span class="btn-label">KEYWORD</span>
            </button>
            <button class="action-btn-top cart-btn-large" onclick="app.showOrderComplete()">
              <span class="btn-icon">🛒</span>
              <span class="btn-label">CART</span>
            </button>
          </div>

          <div class="results-summary">
            <div id="resultItemName" class="results-item-name"></div>
            <div class="results-side">
              <div class="results-side-top">
                <button id="favoriteBtnResults" class="favorite-btn-results" onclick="app.toggleCurrentFavorite()">☆</button>
                <div id="resultCompanyBadge" class="company-badge results-company-badge"></div>
              </div>
              <div class="results-side-bottom">
                <div id="estimatedPriceResults" class="estimated-price-results">$0.00</div>
              </div>
            </div>
          </div>


        <!-- 컬러 통계 영역 (고정 위치) - 주석 처리 (나중 사용) -->
        <!--
        <div id="color-stats-container">
          <div class="stats-title">Color info</div>
          <div id="color-stats-content"></div>
        </div>
        -->

          <div class="quantity-controls">
            <!-- 1줄: ALL, +1, +3, +6 -->
            <button class="qty-btn all-toggle" onclick="app.toggleAllMode()">ALL</button>
            <button class="qty-btn" onclick="app.adjustQuantity(1)">+1</button>
            <button class="qty-btn" onclick="app.adjustQuantity(3)">+3</button>
            <button class="qty-btn" onclick="app.adjustQuantity(6)">+6</button>

            <!-- 2줄: +10, +12, CLEAR, 여백 -->
            <button class="qty-btn" onclick="app.adjustQuantity(10)">+10</button>
            <button class="qty-btn" onclick="app.adjustQuantity(12)">+12</button>
            <button class="qty-btn clear" onclick="app.clearQuantity()">CLEAR</button>
            <div class="qty-spacer"></div>
          </div>
        </div>

        <div class="table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th class="qty-col">Qty</th>
                <th class="color-col">COLOR</th>
                <th class="shipped-col">SHIPPED (12MO)</th>
                <th class="price-col">PRICE</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- 키워드 검색 결과 섹션 -->
      <div id="keywordResultsSection">
        <div class="keyword-header">
          <button class="keyword-back-btn" onclick="app.backToKeywordInput()">Back</button>
          <div class="keyword-title">Search results</div>
        </div>
        <div class="keyword-meta" id="keywordMeta"></div>
        <div class="keyword-tabs">
          <button class="keyword-tab" id="tabOutre" onclick="app.switchKeywordCompany('OUTRE')">OUTRE</button>
          <button class="keyword-tab" id="tabSng" onclick="app.switchKeywordCompany('SNG')">SNG</button>
        </div>
        <div class="keyword-filters">
          <button class="keyword-filter active" data-filter="ALL" onclick="app.setKeywordFilter('ALL')">All</button>
          <button class="keyword-filter" data-filter="ACTIVE" onclick="app.setKeywordFilter('ACTIVE')">Active</button>
          <button class="keyword-filter" data-filter="DISCONTINUE_UNKNOWN"
            onclick="app.setKeywordFilter('DISCONTINUE_UNKNOWN')">Discontinue soon</button>
          <button class="keyword-filter" data-filter="DISCONTINUED"
            onclick="app.setKeywordFilter('DISCONTINUED')">Discontinued</button>
        </div>
        <div class="keyword-breakdown-inline" id="keywordBreakdownInline" style="display: none;">
          <div class="keyword-breakdown-label">Keywords:</div>
          <div class="keyword-breakdown-buttons-inline" id="keywordBreakdownButtonsInline"></div>
        </div>
        <div id="keywordResultsList" class="keyword-list"></div>
        <div id="keywordEmpty" class="keyword-empty" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- 카메라 모달 -->
  <div id="cameraModal">
    <div class="camera-header">Align the barcode in the center</div>
    <div class="camera-viewport">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="scan-guide"></div>
      <div class="scan-tip" id="scanTip">Align the barcode inside the guide</div>
    </div>
    <div class="camera-footer">
      <button class="close-camera-btn" onclick="app.closeCamera()">Close</button>
    </div>
  </div>

  <!-- 백오더 프롬프트 모달 -->
  <div id="backorderModal">
    <div class="backorder-modal-content">
      <div class="backorder-modal-header">Backorder auto-fill</div>
      <div class="backorder-modal-body">
        <div class="backorder-modal-message">Auto-fill backorder quantity?<br>(Shown in green)</div>
        <div class="backorder-modal-buttons">
          <button class="backorder-btn yes" onclick="app.handleBackorderChoice(true)">YES</button>
          <button class="backorder-btn no" onclick="app.handleBackorderChoice(false)">NO</button>
        </div>
        <div class="backorder-remember" onclick="app.toggleBackorderRemember()">
          <input type="checkbox" id="backorderRememberCheckbox">
          <label for="backorderRememberCheckbox">Remember this choice</label>
        </div>
      </div>
    </div>
  </div>

  <!-- 키워드 분석 모달 -->
  <div id="keywordBreakdownModal">
    <div class="keyword-breakdown-content">
      <div class="keyword-breakdown-header">
        <button class="keyword-breakdown-back" onclick="app.closeKeywordBreakdown()">← Back</button>
        <div class="keyword-breakdown-title">Select keywords to search</div>
      </div>
      <div class="keyword-breakdown-body">
        <div class="keyword-breakdown-product" id="keywordBreakdownProduct"></div>
        <div class="keyword-breakdown-buttons" id="keywordBreakdownButtons"></div>
        <div class="keyword-breakdown-selected" id="keywordBreakdownSelected">
          <div class="selected-label">Selected keywords:</div>
          <div class="selected-keywords" id="selectedKeywords"></div>
        </div>
        <button class="keyword-breakdown-search" onclick="app.searchSelectedKeywords()">🔍 Search</button>
      </div>
    </div>
  </div>

  <!-- ORDER COMPLETE 모달 -->
  <div id="orderModal">
    <div class="order-modal-content">
      <div class="order-modal-header">Order summary</div>

      <!-- 회사 탭 -->
      <div class="company-tabs">
        <button class="company-tab tab-sng active" onclick="app.switchCompany('SNG')">
          <span class="tab-label">SNG</span>
          <span class="tab-amount" id="tabAmountSng">$0.00</span>
        </button>
        <button class="company-tab tab-outre" onclick="app.switchCompany('OUTRE')">
          <span class="tab-label">OUTRE</span>
          <span class="tab-amount" id="tabAmountOutre">$0.00</span>
        </button>
      </div>

      <div class="order-modal-body" id="orderModalBody">
        <!-- 데이터가 여기에 표시됩니다 -->
      </div>
      <div class="order-modal-footer">
        <button class="modal-btn copy" onclick="app.copyOrderData()">Copy</button>
        <button class="modal-btn clear-list" onclick="app.clearOrderList()">Clear list</button>
        <button class="modal-btn close" onclick="app.closeOrderModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- 수량 입력 플래시 -->
  <div id="quantityFlash"></div>

  <!-- 알림 메시지 -->
  <div id="alertMessage"></div>

  <script>
    // ============================================================================
    // CC3 HAIR ORDER APP - Frontend v4.2
    // Multi-Company Support (OUTRE + SNG) + Product Search + Status Management
    // ============================================================================

    // ============================================================================
    // 상태 매핑 테이블 (UI 렌더링 정책)
    // ============================================================================
    var STATUS_CONFIG = {
      'NEW': {
        label: 'New',
        badgeClass: 'badge-new',
        rowClass: 'status-new',
        showBadge: true,
        allowInput: true
      },
      'ACTIVE': {
        label: 'Active',
        badgeClass: '',
        rowClass: 'status-active',
        showBadge: false,
        allowInput: true
      },
      'DISCONTINUE_UNKNOWN': {
        label: 'Discontinue soon',
        badgeClass: 'badge-discontinue-unknown',
        rowClass: 'status-discontinue-unknown',
        showBadge: true,
        allowInput: true  // 정책: 현재는 허용, 필요시 false로 변경 가능
      },
      'DISCONTINUED': {
        label: 'Discontinued',
        badgeClass: 'badge-discontinued',
        rowClass: 'status-discontinued',
        showBadge: true,
        allowInput: false
      }
    };

    /**
     * 상태 코드를 UI 설정으로 변환
     * @param {string} status - 상태 코드 (예: 'DISCONTINUED')
     * @return {object} UI 설정 객체
     */
    function getStatusConfig(status) {
      return STATUS_CONFIG[status] || STATUS_CONFIG['ACTIVE'];
    }

    /**
     * HTML 이스케이프 (XSS 방지)
     */
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeRegExp(text) {
      return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function normalizeOrderDescription(text) {
      return (text || '').toString().trim().toUpperCase();
    }

    function normalizeOrderKey(value) {
      if (value === null || value === undefined) return '';
      return value.toString().trim().replace(/^0+/, '');
    }

    function normalizeColorValue(color) {
      return (color || '').toString().toUpperCase().replace(/[\s\-_]+/g, '').trim();
    }

    var app = {
      // 상태
      barcode: '',
      products: [],
      selectedRow: -1,
      cameraActive: false,
      processing: false,
      allMode: false,
      orderData: {},  // { OUTRE: [], SNG: [] }
      detectionBuffer: {},
      currentCompany: null,  // 현재 스캔된 회사 (OUTRE or SNG)
      currentPrimaryBarcode: '',
      lastSearchSource: '',
      viewingCompany: 'SNG',  // 장바구니에서 보고 있는 회사
      keyboardMode: false,
      keywordQuery: '',
      keywordResults: { OUTRE: [], SNG: [] },
      keywordMeta: null,
      activeKeywordCompany: '',
      keywordFilter: 'ALL',
      keywordReturnEnabled: false,
      lastSelectedCompany: '',
      history: [],
      favorites: [],
      backorderPrompted: false,
      availableKeywords: [],
      selectedKeywordsList: [],
      orderLoadRequestId: { SNG: 0, OUTRE: 0 },
      orderDescriptionMap: { OUTRE: {}, SNG: {} },
      pendingSelectColor: '',
      pendingSelectBarcode: '',
      pendingCartQuantity: '', // 장바구니에서 가져온 수량 (단일 - 이전 버전 호환용)
      pendingCartQuantityMap: {}, // 장바구니에서 가져온 모든 컬러별 수량 맵
      cartTotals: { OUTRE: null, SNG: null },

      // DOM 요소
      barcodeDisplay: null,
      inputSection: null,
      resultsSection: null,
      loading: null,
      productsTableBody: null,
      resultItemName: null,
      resultCompanyBadge: null,
      keywordResultsSection: null,
      keywordResultsList: null,
      keywordMetaEl: null,
      keywordEmptyEl: null,
      tabOutre: null,
      tabSng: null,
      keywordBackRow: null,
      searchBtn: null,
      keyboardBtn: null,
      historyList: null,
      historyEmpty: null,
      favoritesList: null,
      favoritesEmpty: null,
      cameraModal: null,
      backorderModal: null,
      orderModal: null,
      orderModalBody: null,
      alertMessage: null,
      quantityFlashEl: null,
      clearBtn: null,
      keywordBreakdownModal: null,
      selectedKeywordsList: [],
      allDatabaseResults: { OUTRE: [], SNG: [] }, // 전체 DB 검색 결과 저장

      // 초기화
      init: function () {
        console.log('=== CC3 HAIR ORDER APP 시작 ===');

        // DOM 요소 캐싱
        this.barcodeDisplay = document.getElementById('barcodeDisplay');
        this.inputSection = document.getElementById('inputSection');
        this.resultsSection = document.getElementById('resultsSection');
        this.loading = document.getElementById('loading');
        this.productsTableBody = document.getElementById('productsTableBody');
        this.resultItemName = document.getElementById('resultItemName');
        this.resultCompanyBadge = document.getElementById('resultCompanyBadge');
        this.keywordResultsSection = document.getElementById('keywordResultsSection');
        this.keywordResultsList = document.getElementById('keywordResultsList');
        this.keywordMetaEl = document.getElementById('keywordMeta');
        this.keywordEmptyEl = document.getElementById('keywordEmpty');
        this.tabOutre = document.getElementById('tabOutre');
        this.tabSng = document.getElementById('tabSng');
        this.keywordBackRow = document.getElementById('keywordBackRow');
        this.searchBtn = document.querySelector('.search-btn');
        this.keyboardBtn = document.querySelector('.keyboard-btn');
        this.historyList = document.getElementById('historyList');
        this.historyEmpty = document.getElementById('historyEmpty');
        this.favoritesList = document.getElementById('favoritesList');
        this.favoritesEmpty = document.getElementById('favoritesEmpty');
        this.cameraModal = document.getElementById('cameraModal');
        this.backorderModal = document.getElementById('backorderModal');
        this.orderModal = document.getElementById('orderModal');
        this.orderModalBody = document.getElementById('orderModalBody');
        this.alertMessage = document.getElementById('alertMessage');
        this.quantityFlashEl = document.getElementById('quantityFlash');
        this.clearBtn = document.getElementById('clearBtn');
        this.keywordBreakdownModal = document.getElementById('keywordBreakdownModal');

        // 바코드 입력 이벤트
        this.barcodeDisplay.addEventListener('input', this.onBarcodeInput.bind(this));
        this.barcodeDisplay.addEventListener('paste', this.onBarcodePaste.bind(this));
        this.barcodeDisplay.addEventListener('keydown', this.onBarcodeKeyDown.bind(this));

        // 바코드 스캐너 설정
        this.setupBarcodeScanner();

        // 기본 스캔 모드 (키보드 비활성)
        this.setKeyboardMode(false);

        // 최근 검색/즐겨찾기 로드
        this.loadLocalHistory();
        this.loadLocalFavorites();
        this.renderHistory();
        this.renderFavorites();
        this.restoreHistoryFromServer();
        this.restoreFavoritesFromServer();

        // 주문 데이터 미리 로드 (하이라이트 및 가격 표시용)
        this.loadOrderData('SNG');
        this.loadOrderData('OUTRE');

        console.log('초기화 완료');
      },

      // 바코드 스캐너 설정 (하드웨어 스캐너)
      setupBarcodeScanner: function () {
        var self = this;
        var scanBuffer = '';
        var scanTimeout = null;

        document.addEventListener('keydown', function (e) {
          if (self.cameraActive || self.orderModal.classList.contains('active') || self.keyboardMode) {
            return;
          }

          if (e.key.length === 1 && /[0-9]/.test(e.key)) {
            scanBuffer += e.key;

            clearTimeout(scanTimeout);
            scanTimeout = setTimeout(function () {
              if (scanBuffer.length === 12) {
                console.log('스캐너 입력:', scanBuffer);
                self.handleSearchInput(scanBuffer, 'scanner');
              }
              scanBuffer = '';
            }, 100);
          } else if (e.key === 'Enter' && scanBuffer.length === 12) {
            e.preventDefault();
            console.log('스캐너 입력 (Enter):', scanBuffer);
            clearTimeout(scanTimeout);
            self.handleSearchInput(scanBuffer, 'scanner');
            scanBuffer = '';
          }
        });
      },

      // 바코드 입력
      onBarcodeInput: function (e) {
        this.barcode = e.target.value.trim();

        // 지우기 버튼 표시 여부
        if (this.clearBtn) {
          this.clearBtn.style.display = this.barcode ? 'flex' : 'none';
        }

        // 입력값 있으면 안내 문구 숨김 (하위 호환성 유지)
        if (this.inputPlaceholder) {
          if (this.barcode) {
            this.inputPlaceholder.classList.add('hidden');
          } else {
            this.inputPlaceholder.classList.remove('hidden');
          }
        }
      },

      // 바코드 키다운
      onBarcodeKeyDown: function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (this.keyboardMode) {
            this.searchFromKeyboard();
          } else {
            this.searchProduct();
          }
        }
      },

      // 바코드 붙여넣기
      onBarcodePaste: function (e) {
        e.preventDefault();
        var pastedText = (e.clipboardData || window.clipboardData).getData('text');
        var cleaned = pastedText.trim().substring(0, 50);

        var self = this;
        setTimeout(function () {
          self.handleSearchInput(cleaned, 'paste');
        }, 100);
      },

      // 숫자 추가
      addDigit: function (digit) {
        if (this.barcode.length < 50) {
          this.barcode += digit;
          this.barcodeDisplay.value = this.barcode;
        }
      },

      // 한 자리 삭제
      deleteDigit: function () {
        this.barcode = this.barcode.slice(0, -1);
        this.barcodeDisplay.value = this.barcode;
      },

      // 바코드 초기화
      clearBarcode: function () {
        this.barcode = '';
        this.barcodeDisplay.value = '';

        if (this.clearBtn) {
          this.clearBtn.style.display = 'none';
        }

        // 안내 문구 다시 표시
        if (this.inputPlaceholder) {
          this.inputPlaceholder.classList.remove('hidden');
        }

        if (this.keyboardMode) {
          this.barcodeDisplay.focus();
        }
      },

      toggleKeyboardMode: function () {
        this.setKeyboardMode(!this.keyboardMode);
      },

      setKeyboardMode: function (enabled) {
        this.keyboardMode = !!enabled;
        if (this.keyboardMode) {
          this.barcodeDisplay.removeAttribute('readonly');
          this.barcodeDisplay.setAttribute('inputmode', 'text');
          var self = this;
          setTimeout(function () {
            self.barcodeDisplay.focus();
          }, 50);
          if (this.keyboardBtn) {
            this.keyboardBtn.classList.add('active');
          }
        } else {
          this.barcodeDisplay.setAttribute('readonly', 'readonly');
          this.barcodeDisplay.setAttribute('inputmode', 'none');
          this.barcodeDisplay.blur();
          if (this.keyboardBtn) {
            this.keyboardBtn.classList.remove('active');
          }
        }
      },

      // ========================================
      // 통합 입력 처리 함수 (카메라/키보드/스캐너 공통)
      // ========================================
      handleSearchInput: function (value, source) {
        if (this.processing) return;

        var input = (value || '').trim();
        if (!input) {
          this.showAlert('Please enter a search term.');
          return;
        }

        console.log('[입력 처리] source=' + source + ', value=' + input);

        this.lastSearchSource = source || '';
        this.keywordReturnEnabled = false;
        this.barcode = input;
        this.barcodeDisplay.value = input;

        if (this.clearBtn) {
          this.clearBtn.style.display = input ? 'flex' : 'none';
        }

        // 12자리 숫자 → 바코드 검색
        if (/^\d{12}$/.test(input)) {
          this.searchProduct();
          return;
        }

        // 그 외 → 키워드 검색
        this.keywordQuery = input;
        this.processing = true;
        this.showSection('loading');

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            self.handleKeywordSearchSuccess(result);
          })
          .withFailureHandler(function (error) {
            self.handleKeywordSearchError(error);
          })
          .searchByKeyword(input, this.lastSelectedCompany || '');
      },

      searchFromKeyboard: function () {
        this.handleSearchInput(this.barcode, 'keyboard');
      },

      // 제품 검색
      searchProduct: function () {
        if (this.processing) return;

        if (!this.barcode || this.barcode.trim() === '') {
          this.showAlert('Please enter a search term.');
          return;
        }

        this.lastSearchSource = 'manual';
        console.log('제품 검색:', this.barcode);

        this.keywordReturnEnabled = false;

        this.processing = true;
        this.showSection('loading');

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            self.handleSearchSuccess(result);
          })
          .withFailureHandler(function (error) {
            self.handleSearchError(error);
          })
          .searchProduct(this.barcode);
      },

      // 검색 성공
      handleSearchSuccess: function (result) {
        this.processing = false;

        if (!result.success) {
          this.showAlert(result.error);
          this.showSection('input');
          this.clearBarcode();
          return;
        }

        console.log('검색 성공:', result.products.length, '개 (' + result.company + ')');

        this.products = result.products || [];
        this.currentCompany = result.company;  // OUTRE 또는 SNG
        this.allMode = false;
        this.updateAllToggle();

        var backorderPreference = localStorage.getItem('backorderAutoFill');
        if (backorderPreference === 'false') {
          for (var i = 0; i < this.products.length; i++) {
            if (this.products[i].backorderApplied) {
              this.products[i].backorderApplied = false;
              this.products[i].quantity = 0;
            }
          }
        }

        // ========================================
        // 메타 정보 처리 (알림 표시)
        // ========================================
        if (result.meta && result.meta.alert) {
          var alert = result.meta.alert;
          this.showAlert(alert.message);
        }

        // ========================================
        // 컬러 통계 표시
        // ========================================
        this.displayColorStats(result.meta);

        var firstProduct = null;
        for (var i = 0; i < this.products.length; i++) {
          if (!this.products[i].isGroupHeader) {
            firstProduct = this.products[i];
            break;
          }
        }
        if (!firstProduct && this.products.length > 0) {
          firstProduct = this.products[0];
        }
        if (this.resultItemName) {
          this.resultItemName.textContent = firstProduct ? (firstProduct.itemName || '') : '';
        }
        var primaryFromMeta = result.meta && result.meta.primaryBarcode ? result.meta.primaryBarcode : '';
        if (!primaryFromMeta && firstProduct && firstProduct.barcode) {
          primaryFromMeta = firstProduct.barcode;
        }
        this.currentPrimaryBarcode = primaryFromMeta;
        if (this.resultCompanyBadge) {
          this.resultCompanyBadge.textContent = this.currentCompany || '';
          this.resultCompanyBadge.className = 'company-badge results-company-badge ' +
            (this.currentCompany === 'OUTRE' ? 'outre' : 'sng');
        }

        // 테마 적용
        this.applyTheme(this.currentCompany);

        this.displayProducts();
        this.showSection('results');
        if (this.keywordBackRow) {
          this.keywordBackRow.style.display = this.keywordReturnEnabled ? 'flex' : 'none';
        }

        // ========================================
        // 백오더 자동 입력 프롬프트
        // ========================================
        var hasBackorder = false;
        for (var i = 0; i < this.products.length; i++) {
          var product = this.products[i];
          if (product.backorderApplied || (product.backorder2mo && product.backorder2mo > 0)) {
            hasBackorder = true;
            break;
          }
        }

        if (hasBackorder) {
          // localStorage에서 사용자 설정 확인
          if (backorderPreference === null) {
            // 설정이 없으면 모달 표시
            if (!this.backorderPrompted) {
              this.showBackorderModal();
              this.backorderPrompted = true;
            }
          } else if (backorderPreference === 'true') {
            // YES로 기억한 경우 알림 표시
            this.showAlert('Backorder auto-fill applied (green).');
          }
          // NO로 기억한 경우 아무것도 표시하지 않음
        }

        // 우선 선택할 컬러가 있으면 해당 컬러로 이동
        var selectBarcode = '';
        if (!this.pendingSelectBarcode) {
          if (this.lastSearchSource === 'camera' && result.meta && result.meta.scannedBarcode) {
            selectBarcode = result.meta.scannedBarcode;
          } else if (result.meta && result.meta.primaryBarcode) {
            selectBarcode = result.meta.primaryBarcode;
          }
          if (selectBarcode) {
            this.pendingSelectBarcode = selectBarcode;
          }
        }

        var preferredIndex = -1;
        if (this.pendingSelectBarcode || this.pendingSelectColor) {
          var targetBarcode = normalizeOrderKey(this.pendingSelectBarcode);
          var targetColor = normalizeColorValue(this.pendingSelectColor);
          for (var i = 0; i < this.products.length; i++) {
            if (this.products[i].isGroupHeader) continue;
            if (targetBarcode) {
              var rowBarcode = normalizeOrderKey(this.products[i].itemNumber || this.products[i].barcode);
              if (rowBarcode && rowBarcode === targetBarcode) {
                preferredIndex = i;
                break;
              }
            }
            if (preferredIndex === -1 && targetColor) {
              var rowColor = normalizeColorValue(this.products[i].color);
              if (rowColor && rowColor === targetColor) {
                preferredIndex = i;
              }
            }
          }
        }

        // ========================================
        // 장바구니에서 온 경우 모든 컬러의 수량 적용
        // ========================================
        if (this.pendingCartQuantityMap && Object.keys(this.pendingCartQuantityMap).length > 0) {
          console.log('장바구니 수량 맵 적용 시작:', this.pendingCartQuantityMap);

          for (var i = 0; i < this.products.length; i++) {
            if (this.products[i].isGroupHeader) continue;

            var productColor = normalizeColorValue(this.products[i].color);
            if (productColor && this.pendingCartQuantityMap[productColor]) {
              var cartQty = this.pendingCartQuantityMap[productColor];
              this.products[i].quantity = cartQty;
              console.log('  - 컬러 "' + this.products[i].color + '" 수량 적용:', cartQty);
            }
          }
        }

        this.pendingSelectBarcode = '';
        this.pendingSelectColor = '';
        this.pendingCartQuantity = ''; // 초기화
        this.pendingCartQuantityMap = {}; // 초기화

        // 첫 번째 제품 자동 선택 (그룹 헤더 제외)
        var firstIndex = -1;
        if (preferredIndex === -1) {
          for (var i = 0; i < this.products.length; i++) {
            if (!this.products[i].isGroupHeader) {
              firstIndex = i;
              break;
            }
          }
        }
        var targetIndex = preferredIndex !== -1 ? preferredIndex : firstIndex;
        if (targetIndex >= 0) {
          var self = this;
          setTimeout(function () {
            self.selectRow(targetIndex);
            self.scrollToRow(targetIndex);
          }, 100);
        }

        if (!this.keywordReturnEnabled) {
          this.recordHistoryFromResult(result);
        }

        // 즐겨찾기 버튼 및 예상 가격 업데이트
        this.updateFavoriteButton();
        this.updateEstimatedPrice();
      },

      handleKeywordSearchSuccess: function (result) {
        this.processing = false;

        if (!result || !result.success) {
          this.showAlert(result && result.error ? result.error : 'Search failed. Please try again.');
          this.showSection('input');
          return;
        }

        this.keywordResults = result.results || { OUTRE: [], SNG: [] };
        this.keywordMeta = result.meta || null;
        this.activeKeywordCompany = this.selectDefaultKeywordCompany(result);
        this.keywordFilter = 'ALL';
        this.renderKeywordTabs();
        this.renderKeywordResults();

        if (this.keywordMetaEl) {
          var total = (this.keywordMeta && this.keywordMeta.totalCount) ? this.keywordMeta.totalCount : 0;
          this.keywordMetaEl.textContent = 'Results for "' + this.keywordQuery + '" (' + total + ')';
        }

        // 인라인 키워드 필터 표시
        this.displayInlineKeywordFilters();

        this.showSection('keyword-results');
      },

      handleKeywordSearchError: function (error) {
        this.processing = false;
        this.showSection('input');
        this.showAlert('Search failed. Please try again.');
        console.error('키워드 검색 오류:', error);
      },

      selectDefaultKeywordCompany: function (result) {
        var results = result.results || { OUTRE: [], SNG: [] };
        var outreCount = results.OUTRE.length || 0;
        var sngCount = results.SNG.length || 0;

        if (this.lastSelectedCompany && results[this.lastSelectedCompany] && results[this.lastSelectedCompany].length > 0) {
          return this.lastSelectedCompany;
        }

        if (outreCount === 0 && sngCount > 0) return 'SNG';
        if (sngCount === 0 && outreCount > 0) return 'OUTRE';

        if (outreCount > 0 && sngCount > 0) {
          var ratio = Math.max(outreCount / sngCount, sngCount / outreCount);
          if (ratio >= 10) {
            return outreCount > sngCount ? 'OUTRE' : 'SNG';
          }
        }

        return 'OUTRE';
      },

      switchKeywordCompany: function (company) {
        this.activeKeywordCompany = company;
        this.lastSelectedCompany = company;

        // 탭 개수 업데이트
        this.renderKeywordTabs();

        // 현재 필터링된 결과를 다시 렌더링 (회사만 변경)
        this.applyKeywordFiltering();
      },

      setKeywordFilter: function (filter) {
        this.keywordFilter = filter;
        var filters = document.querySelectorAll('.keyword-filter');
        for (var i = 0; i < filters.length; i++) {
          filters[i].classList.toggle('active', filters[i].dataset.filter === filter);
        }
        // 상태 필터 변경 시에도 키워드 필터 적용
        this.applyKeywordFiltering();
      },

      renderKeywordTabs: function () {
        if (!this.tabOutre || !this.tabSng) return;
        var outreCount = (this.keywordResults.OUTRE || []).length;
        var sngCount = (this.keywordResults.SNG || []).length;

        this.tabOutre.textContent = 'OUTRE (' + outreCount + ')';
        this.tabSng.textContent = 'SNG (' + sngCount + ')';

        this.tabOutre.classList.toggle('active', this.activeKeywordCompany === 'OUTRE');
        this.tabSng.classList.toggle('active', this.activeKeywordCompany === 'SNG');
      },

      renderKeywordResults: function (filteredList) {
        if (!this.keywordResultsList || !this.keywordEmptyEl) return;
        this.keywordResultsList.innerHTML = '';

        // filteredList가 제공되면 그것을 사용, 아니면 현재 활성 회사의 리스트 사용
        var list = filteredList || (this.keywordResults[this.activeKeywordCompany] || []);
        var filtered = [];

        // 상태 필터 적용
        for (var i = 0; i < list.length; i++) {
          if (this.passesKeywordFilter(list[i])) {
            // 현재 활성 회사의 제품만 필터링
            if (list[i].company === this.activeKeywordCompany) {
              filtered.push(list[i]);
            }
          }
        }

        if (filtered.length === 0) {
          this.keywordEmptyEl.style.display = 'block';
          this.keywordEmptyEl.textContent = this.buildKeywordEmptyMessage();
          return;
        }

        this.keywordEmptyEl.style.display = 'none';

        // 메타 정보 업데이트 (검색 결과 개수)
        if (this.keywordMetaEl) {
          this.keywordMetaEl.textContent = 'Results: ' + filtered.length;
        }

        // 회사명을 제외한 키워드 추출 (하이라이트용)
        var highlightKeywords = [];
        for (var i = 0; i < this.selectedKeywordsList.length; i++) {
          var kw = this.selectedKeywordsList[i];
          if (kw !== 'OUTRE' && kw !== 'SNG') {
            highlightKeywords.push(kw);
          }
        }

        // 제품 렌더링 (구분자 없이)
        for (var j = 0; j < filtered.length; j++) {
          this.renderKeywordItem(filtered[j], highlightKeywords);
        }
      },

      // 키워드 아이템 렌더링 (하이라이트 포함)
      renderKeywordItem: function (item, highlightKeywords) {
        var row = document.createElement('div');
        row.className = 'keyword-item';
        row.onclick = this.openQuantityView.bind(this, item, true);

        var desc = document.createElement('div');
        desc.className = 'keyword-desc';

        // 키워드 하이라이트 적용
        var descText = item.description || '';
        if (highlightKeywords.length > 0) {
          desc.innerHTML = this.highlightKeywords(descText, highlightKeywords);
        } else {
          desc.textContent = descText;
        }

        if (this.isItemOrdered(item)) {
          desc.className += ' text-shipped';
        }

        var actions = document.createElement('div');
        actions.className = 'keyword-actions';

        var status = document.createElement('div');
        status.className = 'keyword-status';
        status.textContent = this.getKeywordStatusLabel(item);

        var favBtn = document.createElement('button');
        favBtn.className = 'favorite-btn';
        favBtn.textContent = this.isFavorite(item) ? '★' : '☆';
        favBtn.onclick = (function (self, data) {
          return function (e) {
            e.stopPropagation();
            self.toggleFavorite(data);
          };
        })(this, item);

        actions.appendChild(status);
        actions.appendChild(favBtn);
        row.appendChild(desc);
        row.appendChild(actions);

        this.keywordResultsList.appendChild(row);
      },

      // 키워드 하이라이트 함수
      highlightKeywords: function (text, keywords) {
        if (!text) return '';
        if (!keywords || keywords.length === 0) return escapeHtml(text);

        // 1. 키워드 이스케이프 및 정규식 생성
        var escapedKeywords = keywords
          .filter(function(k) { return k && k.length > 0; })
          .map(function(k) { return escapeRegExp(k); });

        if (escapedKeywords.length === 0) return escapeHtml(text);

        var pattern = '(' + escapedKeywords.join('|') + ')';
        var regex = new RegExp(pattern, 'gi');

        // 2. 텍스트를 키워드 기준으로 분리 (캡처 그룹 포함)
        var parts = text.split(regex);
        var result = '';

        // 3. 각 부분을 순회하며 매칭된 부분만 하이라이트 태그 적용
        for (var i = 0; i < parts.length; i++) {
          var part = parts[i];
          if (!part) continue;

          // 해당 부분이 키워드와 일치하는지 확인 (대소문자 무시)
          var isMatch = regex.test(part); 
          // 정규식 test 후 lastIndex가 변경될 수 있으므로 다시 0으로 리셋하거나, 
          // 단순히 parts가 정규식에 의해 쪼개진 것이므로 홀수 인덱스가 매칭된 부분임(캡처 그룹 사용 시)을 이용할 수도 있음.
          // 하지만 간단히 키워드 목록과 비교하는 것이 안전함.
          var lowerPart = part.toLowerCase();
          var isKeyword = false;
          for (var k = 0; k < keywords.length; k++) {
            if (keywords[k].toLowerCase() === lowerPart) {
              isKeyword = true;
              break;
            }
          }

          if (isKeyword) {
            result += '<span class="keyword-highlight">' + escapeHtml(part) + '</span>';
          } else {
            result += escapeHtml(part);
          }
        }
        return result;
      },

      passesKeywordFilter: function (item) {
        if (this.keywordFilter === 'ALL') return true;
        var counts = item.colorCounts || {};
        if (this.keywordFilter === 'ACTIVE') {
          return (counts.active || 0) > 0;
        }
        if (this.keywordFilter === 'DISCONTINUE_UNKNOWN') {
          return (counts.discontinueUnknown || 0) > 0;
        }
        if (this.keywordFilter === 'DISCONTINUED') {
          return (counts.discontinued || 0) > 0;
        }
        return true;
      },

      getKeywordStatusLabel: function (item) {
        var counts = item.colorCounts || {};
        if ((counts.discontinued || 0) > 0 && (counts.active || 0) === 0 && (counts.discontinueUnknown || 0) === 0) {
          return 'Discontinued';
        }
        if ((counts.discontinueUnknown || 0) > 0 && (counts.active || 0) === 0) {
          return 'Discontinue soon';
        }
        if ((counts.discontinued || 0) > 0 || (counts.discontinueUnknown || 0) > 0) {
          return 'Mixed';
        }
        return 'Active';
      },

      buildKeywordEmptyMessage: function () {
        var meta = this.keywordMeta || {};
        var suggestions = meta.suggestions || [];
        var tips = meta.tips || [];
        var lines = ['No results found.'];

        if (suggestions.length > 0) {
          lines.push('Similar keywords: ' + suggestions.join(', '));
        }
        if (tips.length > 0) {
          lines = lines.concat(tips);
        }

        return lines.join(' ');
      },

      backToKeywordInput: function () {
        this.keywordReturnEnabled = false;
        this.clearBarcode(); // 검색창 초기화
        this.showSection('input');
      },

      backToKeywordResults: function () {
        if (!this.keywordReturnEnabled) {
          this.showSection('input');
          return;
        }
        this.renderKeywordTabs();
        this.renderKeywordResults();
        this.showSection('keyword-results');
      },

            openQuantityView: function (item, enableReturn) {

              if (!item) return;

      

              // ========================================

              // CRITICAL: UPC 우선, Description 사용 안함

              // UPC가 있으면 UPC 기반 수량 맵 생성

              // ========================================

              if (item.primaryBarcode && /^\d{12}$/.test(item.primaryBarcode)) {

                this.buildCartQuantityMapByUPC(item.primaryBarcode);

                console.log('openQuantityView - UPC 기반 수량 맵 생성 완료:', this.pendingCartQuantityMap);

              } else {

                // UPC가 없는 경우, 빈 맵으로 시작

                this.pendingCartQuantityMap = {};

                console.log('openQuantityView - UPC 없음. 빈 수량 맵으로 시작.');

              }

              this.keywordReturnEnabled = !!enableReturn;

              this.setKeyboardMode(false);

              this.saveHistoryItem({

                type: enableReturn ? 'search' : 'quick',

                description: item.description,

                company: item.company,

                primaryBarcode: item.primaryBarcode

              });

      

              this.processing = true;

              this.showSection('loading');

      

              var self = this;

              google.script.run

                .withSuccessHandler(function (result) {

                  self.handleSearchSuccess(result);

                })

                .withFailureHandler(function (error) {

                  self.handleSearchError(error);

                })

                .getQuantityViewByDescription(item.description, item.company, item.primaryBarcode);

            },

      // ========================================
      // 컬러 통계 표시 (고정 위치)
      // ========================================
      displayColorStats: function (meta) {
        // DOM 표시 부분 주석 처리 (공간 확보) - 데이터는 정상 처리됨
        /*
        var statsContainer = document.getElementById('color-stats-container');
        var statsContent = document.getElementById('color-stats-content');

        if (!meta || !meta.colorStats) {
          statsContainer.classList.remove('visible');
          return;
        }

        var stats = meta.colorStats;
        statsContent.innerHTML =
          '<div class="stat-item">' +
            '<span class="stat-label">Total</span>' +
            '<span class="stat-value">' + stats.total + '</span>' +
          '</div>' +
          '<div class="stat-item">' +
            '<span class="stat-label">Active</span>' +
            '<span class="stat-value" style="color: #4CAF50;">' + stats.active + '</span>' +
          '</div>' +
          '<div class="stat-item">' +
            '<span class="stat-label">Discontinue soon</span>' +
            '<span class="stat-value" style="color: #FF9800;">' + stats.discontinueUnknown + '</span>' +
          '</div>' +
          '<div class="stat-item">' +
            '<span class="stat-label">Discontinued</span>' +
            '<span class="stat-value" style="color: #f44336;">' + stats.discontinued + '</span>' +
          '</div>';

        statsContainer.classList.add('visible');
        */
      },

      // 검색 실패
      handleSearchError: function (error) {
        this.processing = false;
        this.showSection('input');
        this.showAlert('Search failed. Please try again.');
        console.error('검색 오류:', error);
        this.clearBarcode();
      },

      // 테마 적용
      applyTheme: function (company) {
        var theme = company === 'OUTRE' ? 'theme-outre' : 'theme-sng';

        // body 테마
        document.body.className = theme;

        // 헤더 테마
        var header = document.querySelector('.header');
        header.className = 'header ' + theme;

        // 프라이머리 버튼 테마 (Scan Barcode)
        var primaryBtn = document.querySelector('.ios-btn.primary');
        if (primaryBtn) {
          primaryBtn.classList.remove('theme-outre', 'theme-sng');
          primaryBtn.classList.add(theme);
        }

        // 키패드 버튼 테마
        var keyBtns = document.querySelectorAll('.key-btn:not(.delete)');
        for (var i = 0; i < keyBtns.length; i++) {
          keyBtns[i].className = 'key-btn ' + theme;
        }

        // 로딩 스피너 테마
        var spinner = document.querySelector('.spinner');
        spinner.className = 'spinner ' + theme;

        var loadingText = document.querySelector('.loading-text');
        loadingText.className = 'loading-text ' + theme;

        // 수량 버튼 테마
        var qtyBtns = document.querySelectorAll('.qty-btn:not(.clear)');
        for (var i = 0; i < qtyBtns.length; i++) {
          qtyBtns[i].className = 'qty-btn ' + theme;
        }

        // 테이블 테마
        var productsTable = document.querySelector('.products-table');
        productsTable.className = 'products-table ' + theme;

        // 상단 액션 버튼 테마 (추가 버튼만)
        var addBtnTop = document.querySelector('.action-btn-top.add');
        if (addBtnTop) {
          addBtnTop.className = 'action-btn-top add ' + theme;
        }

        // 카메라 헤더 테마
        var cameraHeader = document.querySelector('.camera-header');
        cameraHeader.className = 'camera-header ' + theme;
      },

      // 제품 표시
      displayProducts: function () {
        this.productsTableBody.innerHTML = '';

        var theme = this.currentCompany === 'OUTRE' ? 'theme-outre' : 'theme-sng';

        for (var i = 0; i < this.products.length; i++) {
          var product = this.products[i];
          var row = this.productsTableBody.insertRow();
          row.dataset.index = i;

          if (product.isGroupHeader) {
            row.className = 'group-header-row';
            var headerCell = row.insertCell(0);
            headerCell.colSpan = 4;
            headerCell.className = 'group-header-cell';
            headerCell.textContent = product.itemName || '';
            continue;
          }

          // ========================================
          // 상태별 행 클래스 적용
          // ========================================
          var statusConfig = getStatusConfig(product.status);
          row.className = statusConfig.rowClass;

          var self = this;
          row.onclick = (function (index) {
            return function () {
              self.selectRow(index);
            };
          })(i);

          // 수량 (첫 번째 컬럼)
          var qtyCell = row.insertCell(0);
          qtyCell.className = 'qty-col';
          var qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.className = 'quantity-input ' + theme;
          qtyInput.value = product.quantity || 0;
          qtyInput.min = 0;
          qtyInput.inputMode = 'numeric';

          // ========================================
          // 상태별 입력 제어
          // ========================================
          if (!statusConfig.allowInput) {
            qtyInput.disabled = true;
            qtyInput.value = 0;
            product.quantity = 0;
          }

          qtyInput.onfocus = function () {
            this.blur();
          };

          qtyInput.onclick = (function (index, input) {
            return function (e) {
              e.stopPropagation();
              input.blur();
              self.selectRow(index);
            };
          })(i, qtyInput);

          qtyInput.oninput = (function (index, input) {
            return function () {
              var val = parseInt(input.value) || 0;
              self.products[index].quantity = Math.max(0, val);
              input.value = self.products[index].quantity;
              self.showQuantityFlash(self.products[index].quantity);
              self.updateEstimatedPrice();
            };
          })(i, qtyInput);

          qtyCell.appendChild(qtyInput);

          // 입력 불가 라벨 추가 (DISCONTINUED)
          if (!statusConfig.allowInput) {
            var disabledLabel = document.createElement('div');
            disabledLabel.className = 'input-disabled-label';
            disabledLabel.textContent = 'Disabled';
            qtyCell.appendChild(disabledLabel);
          }

          // COLOR (두 번째 컬럼) + 상태 배지
          var colorCell = row.insertCell(1);
          colorCell.className = 'color-col';
          colorCell.textContent = product.color || '';

          // ========================================
          // 상태 배지 추가
          // ========================================
          if (statusConfig.showBadge) {
            var badge = document.createElement('span');
            badge.className = 'status-badge ' + statusConfig.badgeClass;
            badge.textContent = statusConfig.label;
            colorCell.appendChild(badge);
          }

          if (product.backorder2mo > 0) {
            colorCell.className += ' color-backorder';
          } else if (product.shipped12mo > 0) {
            colorCell.className += ' color-shipped';
          }

          var shippedCell = row.insertCell(2);
          shippedCell.className = 'shipped-col';
          var shippedValue = product.shipped12mo;
          if (shippedValue === undefined || shippedValue === null || isNaN(shippedValue)) {
            shippedValue = 0;
          }
          shippedCell.textContent = shippedValue;

          var priceCell = row.insertCell(3);
          priceCell.className = 'price-col';
          var priceText = document.createElement('div');
          priceText.className = 'price-text';
          priceText.textContent = product.priceHistory || '';
          priceCell.appendChild(priceText);
        }
      },

      // 주문 페이지로 이동
      gotoOrderPage: function (company) {
        console.log('주문 페이지 이동:', company);
        this.viewingCompany = company;
        this.showOrderComplete();
      },

      // 행 선택
      selectRow: function (index) {
        if (index < 0 || index >= this.products.length) return;

        var rows = this.productsTableBody.rows;
        for (var i = 0; i < rows.length; i++) {
          rows[i].classList.remove('selected');
        }

        rows[index].classList.add('selected');
        this.selectedRow = index;
      },

      // 특정 행으로 스크롤
      scrollToRow: function (index) {
        if (index < 0 || index >= this.products.length) return;

        var rows = this.productsTableBody.rows;
        if (!rows[index]) return;

        var targetRow = rows[index];
        var tableContainer = document.querySelector('.table-container');

        if (!tableContainer) return;

        // 테이블 컨테이너 내에서 행의 상대적 위치 계산
        var containerRect = tableContainer.getBoundingClientRect();
        var rowRect = targetRow.getBoundingClientRect();

        // 행이 컨테이너의 중앙에 오도록 스크롤
        var scrollOffset = (rowRect.top - containerRect.top) + tableContainer.scrollTop - (containerRect.height / 2) + (rowRect.height / 2);

        // 부드러운 스크롤
        tableContainer.scrollTo({
          top: scrollOffset,
          behavior: 'smooth'
        });

        console.log('행으로 스크롤: index=' + index);
      },

      // 수량 조절
      adjustQuantity: function (amount) {
        if (this.allMode) {
          for (var i = 0; i < this.products.length; i++) {
            this.products[i].quantity = Math.max(0, (this.products[i].quantity || 0) + amount);
          }
          this.displayProducts();
          this.showQuantityFlash('ALL');
          this.allMode = false;
          this.updateAllToggle();
          this.updateEstimatedPrice();
          return;
        }

        if (this.selectedRow === -1) return;

        this.products[this.selectedRow].quantity = Math.max(0,
          (this.products[this.selectedRow].quantity || 0) + amount);

        this.displayProducts();
        this.selectRow(this.selectedRow);
        this.showQuantityFlash(this.products[this.selectedRow].quantity);
        this.updateEstimatedPrice();
      },

      // 수량 초기화
      clearQuantity: function () {
        if (this.allMode) {
          for (var i = 0; i < this.products.length; i++) {
            this.products[i].quantity = 0;
          }
          this.displayProducts();
          this.showQuantityFlash('0');
          this.allMode = false;
          this.updateAllToggle();
          this.updateEstimatedPrice();
          return;
        }

        if (this.selectedRow === -1) return;

        this.products[this.selectedRow].quantity = 0;
        this.displayProducts();
        this.selectRow(this.selectedRow);
        this.showQuantityFlash('0');
        this.updateEstimatedPrice();
      },

      toggleAllMode: function () {
        this.allMode = !this.allMode;
        this.updateAllToggle();
      },

      updateAllToggle: function () {
        var allBtn = document.querySelector('.qty-btn.all-toggle');
        if (allBtn) {
          allBtn.classList.toggle('active', this.allMode);
        }
      },

      // 주문에 추가
      addToOrder: function () {
        var hasQty = false;
        for (var i = 0; i < this.products.length; i++) {
          if ((this.products[i].quantity || 0) > 0) {
            hasQty = true;
            break;
          }
        }

        if (!hasQty) {
          this.showAlert('No quantities entered.');
          return;
        }

        if (this.processing) return;

        console.log('주문 추가 시작 (' + this.currentCompany + ')');

        this.processing = true;
        this.showSection('loading');

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            self.handleAddSuccess(result);
          })
          .withFailureHandler(function (error) {
            self.handleAddError(error);
          })
          .addToOrder(this.products, this.currentCompany);
      },

      // 저장 후 카메라 열기
      saveAndOpenCamera: function () {
        var hasQty = false;
        for (var i = 0; i < this.products.length; i++) {
          if ((this.products[i].quantity || 0) > 0) {
            hasQty = true;
            break;
          }
        }

        if (!hasQty) {
          // 수량 없으면 그냥 카메라만 열기
          this.reset();
          this.openCamera();
          return;
        }

        if (this.processing) return;

        console.log('저장 후 카메라 열기 (' + this.currentCompany + ')');

        this.processing = true;
        this.showSection('loading');

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            self.handleSaveAndCameraSuccess(result);
          })
          .withFailureHandler(function (error) {
            self.handleAddError(error);
          })
          .addToOrder(this.products, this.currentCompany);
      },

      // 저장 후 돌아가기
      saveAndGoBack: function () {
        var hasQty = false;
        for (var i = 0; i < this.products.length; i++) {
          if ((this.products[i].quantity || 0) > 0) {
            hasQty = true;
            break;
          }
        }

        if (!hasQty) {
          // 수량 없으면 그냥 돌아가기
          this.reset();
          return;
        }

        if (this.processing) return;

        console.log('저장 후 돌아가기 (' + this.currentCompany + ')');

        this.processing = true;
        this.showSection('loading');

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            self.handleSaveAndBackSuccess(result);
          })
          .withFailureHandler(function (error) {
            self.handleAddError(error);
          })
          .addToOrder(this.products, this.currentCompany);
      },

      // 추가 성공
      handleAddSuccess: function (result) {
        this.processing = false;

        if (result.success) {
          this.refreshCartTotal(this.currentCompany);
          this.showAlert(result.message, 2000);
          this.reset();
        } else {
          this.showAlert(result.error);
          this.showSection('results');
        }
      },

      // 저장 후 카메라 성공
      handleSaveAndCameraSuccess: function (result) {
        this.processing = false;

        if (result.success) {
          this.refreshCartTotal(this.currentCompany);
          // 알림 없이 바로 리셋하고 카메라 열기
          this.reset();
          var self = this;
          setTimeout(function () {
            self.openCamera();
          }, 100);
        } else {
          this.showAlert(result.error);
          this.showSection('results');
        }
      },

      // 저장 후 돌아가기 성공
      handleSaveAndBackSuccess: function (result) {
        this.processing = false;

        if (result.success) {
          this.refreshCartTotal(this.currentCompany);
          // 알림 없이 바로 리셋
          this.reset();
        } else {
          this.showAlert(result.error);
          this.showSection('results');
        }
      },

      // 추가 실패
      handleAddError: function (error) {
        this.processing = false;
        this.showSection('results');
        this.showAlert('Failed to add items to the order.');
        console.error('추가 오류:', error);
      },

      // 취소 (저장 없이 검색창으로)
      cancelToSearch: function () {
        var self = this;
        this.persistOrderAndThen(function () {
          console.log('저장 없이 검색창으로 돌아가기');
          self.reset();
        });
      },

      // 취소
      cancel: function () {
        this.reset();
      },

      // 리셋
      reset: function () {
        this.barcode = '';
        this.products = [];
        this.selectedRow = -1;
        this.processing = false;
        this.currentCompany = null;
        this.currentPrimaryBarcode = '';
        this.lastSearchSource = '';
        this.allMode = false;
        this.keywordReturnEnabled = false;
        this.barcodeDisplay.value = '';
        if (this.resultItemName) {
          this.resultItemName.textContent = '';
        }
        if (this.resultCompanyBadge) {
          this.resultCompanyBadge.textContent = '';
          this.resultCompanyBadge.className = 'company-badge results-company-badge';
        }
        this.updateAllToggle();

        // 초기 테마로 복귀
        this.applyTheme(null);

        // 기본 스캔 모드로 복귀
        this.setKeyboardMode(false);

        this.showSection('input');
      },

      // 섹션 표시
      showSection: function (section) {
        var header = document.querySelector('.header');

        this.inputSection.style.display = section === 'input' ? 'block' : 'none';
        this.resultsSection.style.display = section === 'results' ? 'flex' : 'none';
        this.keywordResultsSection.style.display = section === 'keyword-results' ? 'flex' : 'none';
        this.loading.style.display = section === 'loading' ? 'block' : 'none';

        // 결과/키워드 화면에서는 헤더 숨김
        if (section === 'results' || section === 'keyword-results') {
          header.style.display = 'none';
        } else {
          header.style.display = 'block';
        }
      },

      // 알림 표시
      showAlert: function (message, duration) {
        var self = this;
        this.alertMessage.textContent = message;
        this.alertMessage.className = 'show';

        setTimeout(function () {
          self.alertMessage.className = '';
        }, duration || 3000);
      },

      showQuantityFlash: function (value) {
        if (!this.quantityFlashEl) return;
        this.quantityFlashEl.textContent = value;
        this.quantityFlashEl.classList.remove('show');
        void this.quantityFlashEl.offsetWidth;
        this.quantityFlashEl.classList.add('show');
      },

      // 현재 수량을 장바구니에 반영한 뒤 다음 동작 수행
      persistOrderAndThen: function (nextAction) {
        var self = this;
        var hasQty = false;
        for (var i = 0; i < this.products.length; i++) {
          if ((this.products[i].quantity || 0) > 0) {
            hasQty = true;
            break;
          }
        }

        if (!hasQty || !this.currentCompany) {
          if (nextAction) nextAction();
          return;
        }

        if (this.processing) return;

        this.processing = true;
        this.showSection('loading');

        google.script.run
          .withSuccessHandler(function (result) {
            self.processing = false;
            if (!result || !result.success) {
              self.showAlert(result && result.error ? result.error : 'Failed to save quantities.');
              self.showSection('results');
              return;
            }
            self.refreshCartTotal(self.currentCompany);
            if (nextAction) nextAction();
          })
          .withFailureHandler(function (error) {
            self.processing = false;
            self.showAlert('Failed to save quantities.');
            self.showSection('results');
            console.error('자동 저장 오류:', error);
          })
          .addToOrder(this.products, this.currentCompany);
      },

      // ===== 최근 검색 / 즐겨찾기 =====
      buildHistoryKey: function (item) {
        return [item.description, item.company, item.primaryBarcode].join('||');
      },

      isItemOrdered: function (item) {
        if (!item) return false;
        if (item.hasOrder) return true;
        var company = item.company || this.activeKeywordCompany || this.currentCompany;
        var descKey = normalizeOrderDescription(item.description || item.itemName || '');
        if (company && descKey && this.orderDescriptionMap[company] && this.orderDescriptionMap[company][descKey]) {
          return true;
        }
        return (item.primaryShipped12mo || 0) > 0;
      },

      loadLocalHistory: function () {
        try {
          this.history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        } catch (e) {
          this.history = [];
        }
      },

      loadLocalFavorites: function () {
        try {
          this.favorites = JSON.parse(localStorage.getItem('searchFavorites') || '[]');
        } catch (e) {
          this.favorites = [];
        }
      },

      saveHistoryItem: function (item) {
        if (!item || !item.description || !item.company || !item.primaryBarcode) return;
        if (item.hasOrder === undefined) {
          item.hasOrder = (item.primaryShipped12mo || 0) > 0;
        }
        var key = this.buildHistoryKey(item);
        var next = [item];
        for (var i = 0; i < this.history.length; i++) {
          if (this.buildHistoryKey(this.history[i]) !== key) {
            next.push(this.history[i]);
          }
        }
        this.history = next.slice(0, 10);
        localStorage.setItem('searchHistory', JSON.stringify(this.history));
        this.renderHistory();

        google.script.run
          .withFailureHandler(function () {
            console.log('서버 히스토리 백업 실패');
          })
          .saveHistoryToServer(item);
      },

      recordHistoryFromResult: function (result) {
        if (!result || !result.meta || !result.meta.scannedProduct) return;
        var product = result.meta.scannedProduct;
        if (!product.itemName || !product.barcode) return;

        var shipped12mo = 0;
        if (result.products && result.products.length > 0) {
          for (var i = 0; i < result.products.length; i++) {
            if (result.products[i].barcode === product.barcode) {
              shipped12mo = result.products[i].shipped12mo || 0;
              break;
            }
          }
        }

        var primaryBarcode = result.meta && result.meta.primaryBarcode ? result.meta.primaryBarcode : product.barcode;
        this.saveHistoryItem({
          type: 'scan',
          description: product.itemName,
          company: result.company,
          primaryBarcode: primaryBarcode,
          hasOrder: shipped12mo > 0
        });
      },

      restoreHistoryFromServer: function () {
        var self = this;
        google.script.run
          .withSuccessHandler(function (serverHistory) {
            if (!serverHistory || serverHistory.length === 0) return;
            var merged = serverHistory.slice();
            var existing = self.history || [];
            var map = {};
            for (var i = 0; i < merged.length; i++) {
              map[self.buildHistoryKey(merged[i])] = true;
            }
            for (var j = 0; j < existing.length; j++) {
              var key = self.buildHistoryKey(existing[j]);
              if (!map[key]) {
                merged.push(existing[j]);
              }
            }
            self.history = merged.slice(0, 10);
            localStorage.setItem('searchHistory', JSON.stringify(self.history));
            self.renderHistory();
          })
          .getHistoryFromServer();
      },

      renderHistory: function () {
        if (!this.historyList || !this.historyEmpty) return;
        this.historyList.innerHTML = '';
        if (!this.history || this.history.length === 0) {
          this.historyEmpty.style.display = 'block';
          return;
        }
        this.historyEmpty.style.display = 'none';

        for (var i = 0; i < this.history.length; i++) {
          var item = this.history[i];
          var pill = document.createElement('div');
          pill.className = 'quick-item';
          pill.onclick = this.openQuantityView.bind(this, item, false);

          var text = document.createElement('span');
          text.textContent = item.description;
          if (this.isItemOrdered(item)) {
            text.className = 'text-shipped';
          }

          var company = document.createElement('span');
          company.className = 'company-pill ' + (item.company === 'OUTRE' ? 'outre' : 'sng');
          company.textContent = item.company;

          pill.appendChild(text);
          pill.appendChild(company);
          this.historyList.appendChild(pill);
        }
      },

      renderFavorites: function () {
        if (!this.favoritesList || !this.favoritesEmpty) return;
        this.favoritesList.innerHTML = '';
        if (!this.favorites || this.favorites.length === 0) {
          this.favoritesEmpty.style.display = 'block';
          return;
        }
        this.favoritesEmpty.style.display = 'none';

        for (var i = 0; i < this.favorites.length; i++) {
          var item = this.favorites[i];
          var pill = document.createElement('div');
          pill.className = 'quick-item';
          pill.onclick = this.openQuantityView.bind(this, item, false);

          var text = document.createElement('span');
          text.textContent = item.description;
          if (this.isItemOrdered(item)) {
            text.className = 'text-shipped';
          }

          var company = document.createElement('span');
          company.className = 'company-pill ' + (item.company === 'OUTRE' ? 'outre' : 'sng');
          company.textContent = item.company;

          pill.appendChild(text);
          pill.appendChild(company);
          this.favoritesList.appendChild(pill);
        }
      },

      isFavorite: function (item) {
        if (!item) return false;
        var key = this.buildHistoryKey(item);
        for (var i = 0; i < this.favorites.length; i++) {
          if (this.buildHistoryKey(this.favorites[i]) === key) {
            return true;
          }
        }
        return false;
      },

      toggleFavorite: function (item) {
        if (!item) return;
        if (item.hasOrder === undefined) {
          item.hasOrder = (item.primaryShipped12mo || 0) > 0;
        }
        var key = this.buildHistoryKey(item);
        var next = [];
        var removed = false;

        for (var i = 0; i < this.favorites.length; i++) {
          if (this.buildHistoryKey(this.favorites[i]) !== key) {
            next.push(this.favorites[i]);
          } else {
            removed = true;
          }
        }

        if (!removed) {
          next.unshift(item);
        }

        this.favorites = next.slice(0, 20);
        localStorage.setItem('searchFavorites', JSON.stringify(this.favorites));
        this.renderFavorites();
        this.renderKeywordResults();

        google.script.run
          .withFailureHandler(function () {
            console.log('서버 즐겨찾기 백업 실패');
          })
          .saveFavoriteToServer(item, removed ? 'remove' : 'add');
      },

      restoreFavoritesFromServer: function () {
        var self = this;
        google.script.run
          .withSuccessHandler(function (serverFavorites) {
            if (!serverFavorites || serverFavorites.length === 0) return;
            var merged = serverFavorites.slice();
            var map = {};
            for (var i = 0; i < merged.length; i++) {
              map[self.buildHistoryKey(merged[i])] = true;
            }
            for (var j = 0; j < self.favorites.length; j++) {
              var key = self.buildHistoryKey(self.favorites[j]);
              if (!map[key]) {
                merged.push(self.favorites[j]);
              }
            }
            self.favorites = merged.slice(0, 20);
            localStorage.setItem('searchFavorites', JSON.stringify(self.favorites));
            self.renderFavorites();
            self.renderKeywordResults();
          })
          .getFavoritesFromServer();
      },

      // ===== 카메라 기능 (ZXing - 강력한 모바일 지원) =====

      codeReader: null,
      videoElement: null,
      canvasElement: null,
      cameraDeviceId: null,
      cameraPermissionReady: false,

      openCamera: function () {
        var self = this;
        this.persistOrderAndThen(function () {
          console.log('카메라 열기');
          self.setKeyboardMode(false);
          self.cameraModal.classList.add('active');
          self.startCamera();
        });
      },

      ensureCameraPermission: function () {
        var self = this;
        if (this.cameraPermissionReady && this.cameraDeviceId) {
          return Promise.resolve(this.cameraDeviceId);
        }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          return Promise.reject(new Error('Camera not supported.'));
        }

        return navigator.mediaDevices.getUserMedia({ video: true })
          .then(function (stream) {
            var tracks = stream.getTracks();
            for (var i = 0; i < tracks.length; i++) {
              tracks[i].stop();
            }
            self.cameraPermissionReady = true;
            return self.codeReader.listVideoInputDevices();
          })
          .then(function (videoInputDevices) {
            if (!videoInputDevices || videoInputDevices.length === 0) {
              throw new Error('No camera device found.');
            }

            var selectedDeviceId = videoInputDevices[0].deviceId;
            for (var i = 0; i < videoInputDevices.length; i++) {
              var device = videoInputDevices[i];
              var label = device.label.toLowerCase();
              if (label.indexOf('back') > -1 ||
                label.indexOf('rear') > -1 ||
                label.indexOf('환경') > -1 ||
                label.indexOf('후면') > -1) {
                selectedDeviceId = device.deviceId;
                break;
              }
            }

            self.cameraDeviceId = selectedDeviceId;
            return selectedDeviceId;
          });
      },

      startCamera: function () {
        var self = this;

        // ZXing 초기화
        this.codeReader = new ZXing.BrowserMultiFormatReader();
        this.videoElement = document.getElementById('video');
        this.canvasElement = document.getElementById('canvas');

        console.log('ZXing 카메라 시작...');

        this.ensureCameraPermission()
          .then(function (selectedDeviceId) {
            console.log('후면 카메라 선택:', selectedDeviceId);

            // 연속 스캔 시작
            self.codeReader.decodeFromVideoDevice(selectedDeviceId, self.videoElement, function (result, err) {
              if (result && result.text) {
                var scannedBarcode = result.text;
                console.log('바코드 감지:', scannedBarcode);

                // 12자리 숫자 바코드인지 확인
                if (/^\d{12}$/.test(scannedBarcode)) {
                  console.log('✅ 유효한 바코드:', scannedBarcode);

                  // 여러 번 스캔되는 것을 방지하기 위해 즉시 카메라를 닫습니다.
                  self.closeCamera();

                  // 진동으로 사용자에게 피드백
                  if (navigator.vibrate) {
                    navigator.vibrate(150);
                  }

                  // 통합 검색 핸들러를 호출합니다.
                  self.handleSearchInput(scannedBarcode, 'camera');

                } else {
                  // 유효하지 않은 바코드는 무시하고 로그만 남깁니다.
                  console.log('❌ 무시된 바코드 (12자리 숫자 아님):', scannedBarcode);
                }
              }

              // NotFoundException은 계속 스캔 중임을 의미하므로 오류로 처리하지 않습니다.
              if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error('스캔 중 오류 발생:', err);
              }
            });

            self.cameraActive = true;
            console.log('카메라 시작 성공');
          })
          .catch(function (err) {
            console.error('카메라 접근 오류:', err);
            self.showAlert('Unable to start the camera.\n\nPlease check camera permissions.');
            self.closeCamera();
          });
      },

      closeCamera: function () {
        console.log('카메라 닫기');

        try {
          // ZXing 카메라 중지
          if (this.codeReader) {
            this.codeReader.reset();
            this.codeReader = null;
          }

          // 비디오 스트림 중지
          if (this.videoElement && this.videoElement.srcObject) {
            var tracks = this.videoElement.srcObject.getTracks();
            for (var i = 0; i < tracks.length; i++) {
              tracks[i].stop();
            }
            this.videoElement.srcObject = null;
          }
        } catch (e) {
          console.log('카메라 중지 오류:', e);
        }

        this.cameraModal.classList.remove('active');
        this.cameraActive = false;
      },

      // ===== ORDER COMPLETE 기능 =====

      showOrderComplete: function () {
        var self = this;
        this.persistOrderAndThen(function () {
          console.log('ORDER COMPLETE 열기');
          self.loadOrderData(self.viewingCompany);
          var otherCompany = self.viewingCompany === 'SNG' ? 'OUTRE' : 'SNG';
          self.loadOrderData(otherCompany);
          self.orderModal.classList.add('active');
        });
      },

      // 회사 전환
      switchCompany: function (company) {
        this.viewingCompany = company;

        // 탭 활성화 상태 변경
        var tabs = document.querySelectorAll('.company-tab');
        for (var i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove('active');
        }

        var activeTab = company === 'SNG' ?
          document.querySelector('.company-tab.tab-sng') :
          document.querySelector('.company-tab.tab-outre');
        activeTab.classList.add('active');

        // 해당 회사 데이터 로드
        this.loadOrderData(company);
      },

      // 주문 데이터 로드
      loadOrderData: function (company) {
        var nextId = (this.orderLoadRequestId[company] || 0) + 1;
        this.orderLoadRequestId[company] = nextId;
        var requestId = nextId;
        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            if (requestId !== self.orderLoadRequestId[company]) return;
            self.displayOrderData(result, company);
          })
          .withFailureHandler(function (error) {
            if (requestId !== self.orderLoadRequestId[company]) return;
            self.showAlert('Failed to load order data.');
            console.error('조회 오류:', error);
          })
          .getOrderData(company);
      },

      displayOrderData: function (result, company) {
        if (!result.success) {
          this.showAlert(result.error);
          return;
        }

        this.orderData[company] = result.data || [];
        // ========================================
        // CRITICAL: UPC 리스트 저장
        // ========================================
        this.orderData[company + '_upcList'] = result.upcList || [];

        var tabAmountEl = document.getElementById(company === 'SNG' ? 'tabAmountSng' : 'tabAmountOutre');
        var total = 0;
        var descriptionMap = {};

        if (this.orderData[company].length > 0) {
          var rows = this.orderData[company];
          var headers = rows[0] || [];
          var dataRows = rows.slice(1);
          var upcList = result.upcList || [];
          var itemNameIdx = headers.indexOf('ITEM NAME');
          var colorIdx = headers.indexOf('COLOR');
          var unitPriceIdx = headers.indexOf('UNIT PRICE');
          var extPriceIdx = headers.indexOf('EXT PRICE');

          if (extPriceIdx !== -1) {
            for (var t = 0; t < dataRows.length; t++) {
              var extVal = dataRows[t][extPriceIdx];
              var parsed = parseFloat(extVal);
              if (!isNaN(parsed)) {
                total += parsed;
              }
            }
          }

          if (itemNameIdx !== -1) {
            for (var m = 0; m < dataRows.length; m++) {
              var descValue = dataRows[m][itemNameIdx];
              var descKey = normalizeOrderDescription(descValue);
              if (descKey) {
                descriptionMap[descKey] = true;
              }
            }
          }

          if (company !== this.viewingCompany) {
            if (tabAmountEl) tabAmountEl.textContent = '$' + total.toFixed(2);
            this.orderDescriptionMap[company] = descriptionMap;
            return;
          }

          // 장바구니에는 ITEM NAME, COLOR, 수량만 표시
          var qtyIdx = headers.indexOf('수량');
          if (qtyIdx === -1) {
            qtyIdx = headers.indexOf('?˜ëŸ‰');
          }

          var displayColumns = [
            { idx: itemNameIdx, header: 'ITEM NAME' },
            { idx: colorIdx, header: 'COLOR' },
            { idx: qtyIdx, header: '수량' }
          ];

          var html = '<div class="order-list">';

          // 헤더 렌더링
          html += '<div class="order-row order-row-header"><div class="order-row-content">';
          for (var h = 0; h < displayColumns.length; h++) {
            if (displayColumns[h].idx !== -1) {
              html += '<div class="order-row-cell">' + escapeHtml(displayColumns[h].header) + '</div>';
            }
          }
          html += '</div></div>';

          // 데이터 행 렌더링
          for (var i = 0; i < dataRows.length; i++) {
            var row = dataRows[i];
            var upcValue = upcList[i] || '';
            var descValue = itemNameIdx !== -1 ? (row[itemNameIdx] || '') : '';
            var colorValue = colorIdx !== -1 ? (row[colorIdx] || '') : '';
            var qtyValue = qtyIdx !== -1 ? (row[qtyIdx] || '') : '';

            var dataAttr = upcValue ? ' data-upc="' + escapeHtml(upcValue) + '"' : '';
            dataAttr += descValue ? ' data-desc="' + escapeHtml(descValue) + '"' : '';
            dataAttr += colorValue ? ' data-color="' + escapeHtml(colorValue) + '"' : '';
            dataAttr += qtyValue ? ' data-qty="' + escapeHtml(qtyValue) + '"' : '';

            html += '<div class="order-row"' + dataAttr + '>';
            html += '<div class="order-row-content">';

            // ITEM NAME, COLOR, 수량만 표시
            for (var j = 0; j < displayColumns.length; j++) {
              if (displayColumns[j].idx !== -1) {
                var cellValue = row[displayColumns[j].idx];
                html += '<div class="order-row-cell">' + escapeHtml(cellValue || '') + '</div>';
              }
            }

            html += '</div>';
            if (upcValue) {
              html += '<button class="order-row-delete" onclick="app.deleteOrderRow(this)">DELETE</button>';
            }
            html += '</div>';
          }

          html += '</div>';
          this.orderModalBody.innerHTML = html;
          this.bindOrderRowSwipes();
          this.bindOrderRowClicks();
        } else if (company === this.viewingCompany) {
          this.orderModalBody.innerHTML = '<div class="empty-message">No orders yet.</div>';
        }

        if (tabAmountEl) {
          tabAmountEl.textContent = '$' + total.toFixed(2);
        }
        this.orderDescriptionMap[company] = descriptionMap;
        this.setCartTotal(company, total);
      },

      bindOrderRowSwipes: function () {
        var rows = this.orderModalBody.querySelectorAll('.order-row[data-upc]');
        var self = this;

        for (var i = 0; i < rows.length; i++) {
          (function (row) {
            var content = row.querySelector('.order-row-content');
            var startX = 0;
            var startY = 0;
            var currentX = 0;
            var touching = false;

            row.addEventListener('touchstart', function (e) {
              if (!e.touches || e.touches.length === 0) return;
              startX = e.touches[0].clientX;
              startY = e.touches[0].clientY;
              currentX = startX;
              touching = true;

              var openRows = self.orderModalBody.querySelectorAll('.order-row.swiped');
              for (var j = 0; j < openRows.length; j++) {
                if (openRows[j] !== row) {
                  openRows[j].classList.remove('swiped');
                }
              }
            });

            row.addEventListener('touchmove', function (e) {
              if (!touching || !e.touches || e.touches.length === 0) return;
              currentX = e.touches[0].clientX;
              var currentY = e.touches[0].clientY;
              var deltaX = currentX - startX;
              var deltaY = currentY - startY;

              if (Math.abs(deltaX) < Math.abs(deltaY)) {
                return;
              }

              if (deltaX < 0) {
                e.preventDefault();
                var translate = Math.max(-80, deltaX);
                content.style.transform = 'translateX(' + translate + 'px)';
              } else {
                content.style.transform = '';
              }
            }, { passive: false });

            row.addEventListener('touchend', function () {
              if (!touching) return;
              var deltaX = currentX - startX;
              content.style.transform = '';
              if (deltaX < -40) {
                row.classList.add('swiped');
              } else {
                row.classList.remove('swiped');
              }
              touching = false;
            });
          })(rows[i]);
        }
      },

      bindOrderRowClicks: function () {
        var rows = this.orderModalBody.querySelectorAll('.order-row[data-upc]');
        var self = this;

        for (var i = 0; i < rows.length; i++) {
          (function (row) {
            var content = row.querySelector('.order-row-content');
            if (!content) return;
            content.addEventListener('click', function (e) {
              if (e.target && e.target.closest('.order-row-delete')) return;
              var desc = row.getAttribute('data-desc') || '';
              var color = row.getAttribute('data-color') || '';
              var upc = row.getAttribute('data-upc') || '';
              var qty = row.getAttribute('data-qty') || '';
              self.openOrderItemFromCart(desc, color, upc, qty);
            });
          })(rows[i]);
        }
      },

      deleteOrderRow: function (button) {
        var row = button.closest('.order-row');
        if (!row) return;
        var upc = row.getAttribute('data-upc');
        if (!upc) return;
        var color = row.getAttribute('data-color') || '';

        // Optimistic UI: remove immediately from the list
        row.parentNode.removeChild(row);
        var remaining = this.orderModalBody.querySelectorAll('.order-row[data-upc]').length;
        if (remaining === 0) {
          this.orderModalBody.innerHTML = '<div class="empty-message">No orders yet.</div>';
        }

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            if (result && result.success) {
              self.loadOrderData(self.viewingCompany);
              self.syncCurrentOrderDeletion(upc, color);
            } else {
              self.showAlert(result && result.error ? result.error : 'Failed to delete item.');
              self.loadOrderData(self.viewingCompany);
            }
          })
          .withFailureHandler(function () {
            self.showAlert('Failed to delete item.');
            self.loadOrderData(self.viewingCompany);
          })
          .removeOrderItem(this.viewingCompany, upc, color);
      },

      openOrderItemFromCart: function (description, color, upc, qty) {
        // ========================================
        // CRITICAL: UPC 우선 사용
        // UPC가 있으면 바코드 검색, 없으면 Description 검색
        // ========================================
        if (!upc && !description) {
          this.showAlert('No product information available.');
          return;
        }

        console.log('장바구니에서 제품 열기:', { description: description, color: color, upc: upc, qty: qty });

        // 장바구니 수량 맵 생성 (UPC 기반, 실패 시 Description fallback)
        this.buildCartQuantityMapByUPC(upc);
        if ((!this.pendingCartQuantityMap || Object.keys(this.pendingCartQuantityMap).length === 0) && description) {
          this.buildCartQuantityMap(description);
          console.log('장바구니 수량 맵 - UPC 매칭 실패, Description fallback:', this.pendingCartQuantityMap);
        }

        this.pendingSelectColor = color || '';
        this.pendingSelectBarcode = upc || '';
        this.keywordReturnEnabled = false;
        this.setKeyboardMode(false);
        this.closeOrderModal();

        // UPC가 있으면 바코드로 검색 (더 정확함)
        if (upc && /^\d{12}$/.test(upc)) {
          console.log('UPC로 검색:', upc);
          this.barcode = upc;
          this.barcodeDisplay.value = upc;
          this.searchProduct();
        } else if (description) {
          // UPC가 없거나 유효하지 않으면 Description으로 검색
          console.log('Description으로 검색:', description);
          this.openQuantityView({
            description: description,
            company: this.viewingCompany,
            primaryBarcode: upc || ''
          }, false);
        } else {
          this.showAlert('Invalid product information.');
        }
      },

      // 장바구니에서 해당 제품의 모든 컬러별 수량 맵 생성
      buildCartQuantityMap: function(description) {
        console.log('========================================');
        console.log('buildCartQuantityMap 호출됨');
        console.log('  Description:', description);
        console.log('  viewingCompany:', this.viewingCompany);

        this.pendingCartQuantityMap = {};

        if (!this.orderData[this.viewingCompany] || this.orderData[this.viewingCompany].length === 0) {
          console.log('  ⚠️ 장바구니 데이터 없음');
          return;
        }

        var rows = this.orderData[this.viewingCompany];
        var headers = rows[0] || [];
        var dataRows = rows.slice(1);

        console.log('  장바구니 헤더:', headers);
        console.log('  장바구니 데이터 행 수:', dataRows.length);

        var itemNameIdx = headers.indexOf('ITEM NAME');
        var colorIdx = headers.indexOf('COLOR');
        var qtyIdx = headers.indexOf('수량');
        if (qtyIdx === -1) {
          qtyIdx = headers.indexOf('?˜ëŸ‰');
        }

        console.log('  컬럼 인덱스 - ITEM NAME:', itemNameIdx, 'COLOR:', colorIdx, '수량:', qtyIdx);

        if (itemNameIdx === -1 || colorIdx === -1 || qtyIdx === -1) {
          console.log('  ⚠️ 필수 컬럼 누락');
          return;
        }

        var normalizedTarget = normalizeOrderDescription(description);
        console.log('  정규화된 타겟:', normalizedTarget);

        var matchCount = 0;
        for (var i = 0; i < dataRows.length; i++) {
          var row = dataRows[i];
          var rowDesc = normalizeOrderDescription(row[itemNameIdx] || '');

          if (rowDesc === normalizedTarget) {
            matchCount++;
            var rowColor = normalizeColorValue(row[colorIdx] || '');
            var rowQty = parseInt(row[qtyIdx]) || 0;

            console.log('  ✓ 매칭됨 [' + i + ']:');
            console.log('    - 원본 Description:', row[itemNameIdx]);
            console.log('    - 정규화 Description:', rowDesc);
            console.log('    - 원본 Color:', row[colorIdx]);
            console.log('    - 정규화 Color:', rowColor);
            console.log('    - 수량:', rowQty);

            if (rowColor && rowQty > 0) {
              this.pendingCartQuantityMap[rowColor] = rowQty;
            }
          }
        }

        console.log('  매칭된 행 수:', matchCount);
        console.log('  최종 수량 맵:', this.pendingCartQuantityMap);
        console.log('========================================');
      },

      // ========================================
      // UPC 기반 장바구니 수량 맵 생성 (더 정확함)
      // ========================================
      buildCartQuantityMapByUPC: function(upc) {
        console.log('========================================');
        console.log('buildCartQuantityMapByUPC 호출됨');
        console.log('  UPC:', upc);
        console.log('  viewingCompany:', this.viewingCompany);

        this.pendingCartQuantityMap = {};

        if (!upc) {
          console.log('  ⚠️ UPC 없음');
          return;
        }

        if (!this.orderData[this.viewingCompany] || this.orderData[this.viewingCompany].length === 0) {
          console.log('  ⚠️ 장바구니 데이터 없음');
          return;
        }

        var rows = this.orderData[this.viewingCompany];
        var headers = rows[0] || [];
        var dataRows = rows.slice(1);
        var upcList = this.orderData[this.viewingCompany + '_upcList'] || [];

        console.log('  장바구니 헤더:', headers);
        console.log('  장바구니 데이터 행 수:', dataRows.length);
        console.log('  UPC 리스트 개수:', upcList.length);

        var colorIdx = headers.indexOf('COLOR');
        var qtyIdx = headers.indexOf('수량');
        if (qtyIdx === -1) {
          qtyIdx = headers.indexOf('?˜ëŸ‰');
        }

        console.log('  컬럼 인덱스 - COLOR:', colorIdx, '수량:', qtyIdx);

        if (colorIdx === -1 || qtyIdx === -1) {
          console.log('  ⚠️ 필수 컬럼 누락');
          return;
        }

        var normalizedTargetUPC = normalizeOrderKey(upc);
        console.log('  정규화된 타겟 UPC:', normalizedTargetUPC);

        var matchCount = 0;
        for (var i = 0; i < dataRows.length; i++) {
          var rowUpc = upcList[i] || '';
          var normalizedRowUPC = normalizeOrderKey(rowUpc);

          if (normalizedRowUPC === normalizedTargetUPC) {
            matchCount++;
            var row = dataRows[i];
            var rowColor = normalizeColorValue(row[colorIdx] || '');
            var rowQty = parseInt(row[qtyIdx]) || 0;

            console.log('  ✓ UPC 매칭됨 [' + i + ']:');
            console.log('    - 원본 UPC:', rowUpc);
            console.log('    - 정규화 UPC:', normalizedRowUPC);
            console.log('    - 원본 Color:', row[colorIdx]);
            console.log('    - 정규화 Color:', rowColor);
            console.log('    - 수량:', rowQty);

            if (rowColor && rowQty > 0) {
              this.pendingCartQuantityMap[rowColor] = rowQty;
            }
          }
        }

        console.log('  매칭된 행 수:', matchCount);
        console.log('  최종 수량 맵:', this.pendingCartQuantityMap);
        console.log('========================================');
      },

      syncCurrentOrderDeletion: function (upc, color) {
        if (!this.products || this.products.length === 0) return;
        if (this.currentCompany !== this.viewingCompany) return;

        var targetUpc = normalizeOrderKey(upc);
        var targetColor = normalizeColorValue(color);
        var updated = false;

        for (var i = 0; i < this.products.length; i++) {
          var product = this.products[i];
          if (product.isGroupHeader) continue;
          var productKey = normalizeOrderKey(product.itemNumber || product.barcode);
          if (targetUpc && productKey !== targetUpc) continue;
          if (targetColor) {
            var productColor = normalizeColorValue(product.color);
            if (productColor !== targetColor) continue;
          }
          product.quantity = 0;
          product.cartQuantity = 0;
          product.backorderApplied = false;
          updated = true;
        }

        if (updated) {
          this.displayProducts();
          // 가격 업데이트는 displayProducts 내부나 별도로 호출 필요 없으나
          // 확실히 하기 위해 호출. 단, 서버 데이터 기준이므로 즉시 반영은 안 될 수 있음.
          // 하지만 로컬 수량이 0이 되었으므로 로컬 계산 로직이 있다면 0으로 줄어듦.
          // 현재 로직 변경으로 서버 데이터만 보여주게 되므로, 서버에서 삭제된 후 다시 로드해야 정확함.
          // loadOrderData가 완료된 시점이므로 updateEstimatedPrice를 호출하면 갱신된 서버 데이터를 가져올 것임.
          this.updateEstimatedPrice(); 
        }
      },

      copyOrderData: function () {
        var data = this.orderData[this.viewingCompany];

        if (!data || data.length === 0) {
          this.showAlert('No data to copy.');
          return;
        }

        var text = '';
        for (var i = 0; i < data.length; i++) {
          text += data[i].join('\t') + '\n';
        }

        var self = this;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function () {
            self.showAlert('Copied.', 2000);
          }).catch(function (err) {
            console.error('복사 실패:', err);
            self.fallbackCopy(text);
          });
        } else {
          this.fallbackCopy(text);
        }
      },

      fallbackCopy: function (text) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
          document.execCommand('copy');
          this.showAlert('Copied.', 2000);
        } catch (err) {
          console.error('복사 실패:', err);
          this.showAlert('Copy failed.');
        }

        document.body.removeChild(textarea);
      },

      clearOrderList: function () {
        var companyName = this.viewingCompany === 'SNG' ? 'SNG' : 'OUTRE';

        if (!confirm(companyName + ' order list will be backed up and cleared. Continue?\n\nA backup will be saved in a hidden tab named with the date and time.')) {
          return;
        }

        console.log('리스트 비우기: ' + this.viewingCompany);

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            if (result.success) {
              self.showAlert(result.message);
              self.loadOrderData(self.viewingCompany);
            } else {
              self.showAlert(result.error);
            }
          })
          .withFailureHandler(function (error) {
            self.showAlert('Failed to clear the list.');
            console.error('비우기 오류:', error);
          })
          .clearOrderList(this.viewingCompany);
      },

      closeOrderModal: function () {
        this.orderModal.classList.remove('active');
        this.showSection('results');
      },

      // ========================================
      // 백오더 모달 제어
      // ========================================
      showBackorderModal: function () {
        console.log('백오더 프롬프트 모달 열기');
        this.backorderModal.classList.add('active');
      },

      closeBackorderModal: function () {
        this.backorderModal.classList.remove('active');
      },

      handleBackorderChoice: function (choice) {
        var rememberCheckbox = document.getElementById('backorderRememberCheckbox');
        if (rememberCheckbox.checked) {
          localStorage.setItem('backorderAutoFill', choice.toString());
        }

        // '아니오' 선택 시, 자동 입력된 백오더 수량을 제거하고 테이블을 새로고침합니다.
        if (choice === false) {
          for (var i = 0; i < this.products.length; i++) {
            if (this.products[i].backorderApplied) {
              this.products[i].backorderApplied = false;
              this.products[i].quantity = 0;
            }
          }
          this.displayProducts(); // 변경사항을 적용하여 테이블을 다시 그립니다.
          this.showAlert('Backorder auto-fill removed.');
        }

        this.closeBackorderModal();
      },

      toggleBackorderRemember: function () {
        var checkbox = document.getElementById('backorderRememberCheckbox');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
        }
      },

      // ========================================
      // 즐겨찾기 토글 (현재 제품)
      // ========================================
      toggleCurrentFavorite: function () {
        if (!this.products || this.products.length === 0) {
          this.showAlert('제품이 없습니다.');
          return;
        }

        // 첫 번째 실제 제품 찾기 (그룹 헤더 제외)
        var firstProduct = null;
        for (var i = 0; i < this.products.length; i++) {
          if (!this.products[i].isGroupHeader) {
            firstProduct = this.products[i];
            break;
          }
        }

        if (!firstProduct) {
          this.showAlert('제품이 없습니다.');
          return;
        }

        var item = {
          description: firstProduct.itemName || '',
          company: this.currentCompany,
          primaryBarcode: this.currentPrimaryBarcode || firstProduct.barcode || '',
          hasOrder: (firstProduct.shipped12mo || 0) > 0
        };

        this.toggleFavorite(item);
        this.updateFavoriteButton();
      },

      // ========================================
      // 즐겨찾기 버튼 상태 업데이트
      // ========================================
      updateFavoriteButton: function () {
        var btn = document.getElementById('favoriteBtnResults');
        if (!btn) return;

        if (!this.products || this.products.length === 0) {
          btn.textContent = '☆';
          return;
        }

        var firstProduct = null;
        for (var i = 0; i < this.products.length; i++) {
          if (!this.products[i].isGroupHeader) {
            firstProduct = this.products[i];
            break;
          }
        }

        if (!firstProduct) {
          btn.textContent = '☆';
          return;
        }

        var item = {
          description: firstProduct.itemName || '',
          company: this.currentCompany,
          primaryBarcode: this.currentPrimaryBarcode || firstProduct.barcode || ''
        };

        btn.textContent = this.isFavorite(item) ? '★' : '☆';
      },

      // ========================================
      // 키워드 분석 - 전체 DB 검색
      // ========================================
      showKeywordBreakdown: function () {
        var self = this;
        this.persistOrderAndThen(function () {
          if (!self.products || self.products.length === 0) {
            self.showAlert('제품이 없습니다.');
            return;
          }

          // 첫 번째 제품명 가져오기
          var itemName = '';
          for (var i = 0; i < self.products.length; i++) {
            if (!self.products[i].isGroupHeader) {
              itemName = self.products[i].itemName || '';
              break;
            }
          }

          if (!itemName) {
            self.showAlert('제품명이 없습니다.');
            return;
          }

          // 키워드로 분리 (공백 기준)
          var keywords = itemName.split(/\s+/).filter(function(k) { return k.length > 0; });

          if (keywords.length === 0) {
            self.showAlert('키워드가 없습니다.');
            return;
          }

          // 회사명도 키워드에 추가
          var companyName = self.currentCompany || 'OUTRE';
          keywords.unshift(companyName);

          // 모든 키워드를 선택된 상태로 설정
          self.selectedKeywordsList = keywords.slice();
          self.availableKeywords = keywords;

          // 전체 DB 검색 (와일드카드 검색)
          self.searchEntireDatabase();
        });
      },

      // 전체 DB 검색 (OUTRE + SNG 모든 제품)
      searchEntireDatabase: function () {
        console.log('전체 DB 검색 시작');
        this.processing = true;
        this.showSection('loading');

        var self = this;
        google.script.run
          .withSuccessHandler(function (result) {
            self.handleDatabaseLoadSuccess(result);
          })
          .withFailureHandler(function (error) {
            self.handleDatabaseLoadError(error);
          })
          .getAllProducts();
      },

      handleDatabaseLoadSuccess: function (result) {
        console.log('전체 DB 로드 성공', result);
        this.processing = false;

        if (!result || !result.success) {
          this.showAlert('Failed to load database. Please try again.');
          this.showSection('input');
          return;
        }

        // 전체 DB 결과 저장
        this.allDatabaseResults = result.results || { OUTRE: [], SNG: [] };

        console.log('로드된 제품 수', {
          OUTRE: this.allDatabaseResults.OUTRE.length,
          SNG: this.allDatabaseResults.SNG.length
        });

        // 인라인 키워드 필터 표시
        this.displayInlineKeywordFilters();

        // 초기 필터링 적용 (모든 키워드 선택 상태)
        this.applyKeywordFiltering();

        // 키워드 결과 화면으로 전환
        this.showSection('keyword-results');

        // 메타 정보는 renderKeywordResults에서 업데이트됨 (검색 결과 개수)
      },

      handleDatabaseLoadError: function (error) {
        console.error('전체 DB 로드 실패', error);
        this.processing = false;
        this.showSection('input');
        this.showAlert('Failed to load database. Please try again.');
      },

      displayKeywordBreakdown: function (itemName, keywords) {
        // 제품명 표시
        var productEl = document.getElementById('keywordBreakdownProduct');
        if (productEl) {
          productEl.textContent = itemName;
        }

        // 키워드 버튼 생성
        var buttonsEl = document.getElementById('keywordBreakdownButtons');
        if (buttonsEl) {
          buttonsEl.innerHTML = '';
          this.selectedKeywordsList = [];

          for (var i = 0; i < keywords.length; i++) {
            var keyword = keywords[i];
            var btn = document.createElement('button');
            btn.className = 'keyword-btn-item';
            btn.textContent = keyword;
            btn.dataset.keyword = keyword;

            var self = this;
            btn.onclick = (function(kw) {
              return function() {
                self.toggleKeywordSelection(kw);
              };
            })(keyword);

            buttonsEl.appendChild(btn);
          }
        }

        // 선택된 키워드 표시 업데이트
        this.updateSelectedKeywords();

        // 모달 열기
        if (this.keywordBreakdownModal) {
          this.keywordBreakdownModal.classList.add('active');
        }
      },

      toggleKeywordSelection: function (keyword) {
        var index = this.selectedKeywordsList.indexOf(keyword);

        if (index > -1) {
          // 이미 선택됨 → 제거
          this.selectedKeywordsList.splice(index, 1);
        } else {
          // 선택 안 됨 → 추가
          this.selectedKeywordsList.push(keyword);
        }

        // 버튼 스타일 업데이트
        var buttons = document.querySelectorAll('.keyword-btn-item');
        for (var i = 0; i < buttons.length; i++) {
          var btn = buttons[i];
          var kw = btn.dataset.keyword;
          if (this.selectedKeywordsList.indexOf(kw) > -1) {
            btn.classList.add('selected');
          } else {
            btn.classList.remove('selected');
          }
        }

        this.updateSelectedKeywords();
      },

      updateSelectedKeywords: function () {
        var selectedEl = document.getElementById('selectedKeywords');
        if (selectedEl) {
          if (this.selectedKeywordsList.length === 0) {
            selectedEl.textContent = 'No keywords selected';
          } else {
            selectedEl.textContent = this.selectedKeywordsList.join(' ');
          }
        }
      },

      searchSelectedKeywords: function () {
        if (this.selectedKeywordsList.length === 0) {
          this.showAlert('Please select at least one keyword.');
          return;
        }

        // 모달 닫기
        this.closeKeywordBreakdown();

        // 선택된 키워드로 검색
        var searchTerms = this.selectedKeywordsList.join(' ');
        this.handleSearchInput(searchTerms, 'keyword-breakdown');
      },

      closeKeywordBreakdown: function () {
        if (this.keywordBreakdownModal) {
          this.keywordBreakdownModal.classList.remove('active');
        }
        this.selectedKeywordsList = [];
      },

      // ========================================
      // 인라인 키워드 필터 표시 및 관리
      // ========================================
      displayInlineKeywordFilters: function () {
        var container = document.getElementById('keywordBreakdownInline');
        var buttonsContainer = document.getElementById('keywordBreakdownButtonsInline');

        if (!container || !buttonsContainer) return;

        // 키워드가 있으면 표시
        if (this.availableKeywords && this.availableKeywords.length > 0) {
          buttonsContainer.innerHTML = '';

          for (var i = 0; i < this.availableKeywords.length; i++) {
            var keyword = this.availableKeywords[i];
            var btn = document.createElement('button');
            btn.className = 'keyword-btn-inline';
            btn.textContent = keyword;
            btn.dataset.keyword = keyword;

            // 초기 상태: 모든 키워드가 선택된 상태 (파란 배경)
            if (this.selectedKeywordsList.indexOf(keyword) > -1) {
              btn.classList.add('selected');
            }

            var self = this;
            btn.onclick = (function(kw) {
              return function() {
                self.toggleInlineKeyword(kw);
              };
            })(keyword);

            buttonsContainer.appendChild(btn);
          }

          container.style.display = 'flex';
        } else {
          container.style.display = 'none';
        }
      },

      toggleInlineKeyword: function (keyword) {
        var index = this.selectedKeywordsList.indexOf(keyword);

        if (index > -1) {
          // 선택 해제
          this.selectedKeywordsList.splice(index, 1);
        } else {
          // 선택
          this.selectedKeywordsList.push(keyword);
        }

        // 버튼 스타일 업데이트
        var buttons = document.querySelectorAll('.keyword-btn-inline');
        for (var i = 0; i < buttons.length; i++) {
          var btn = buttons[i];
          var kw = btn.dataset.keyword;
          if (this.selectedKeywordsList.indexOf(kw) > -1) {
            btn.classList.add('selected');
          } else {
            btn.classList.remove('selected');
          }
        }

        // 필터링 적용
        this.applyKeywordFiltering();
      },

      applyKeywordFiltering: function () {
        console.log('키워드 필터링 적용', {
          selectedKeywords: this.selectedKeywordsList,
          allResultsOUTRE: this.allDatabaseResults.OUTRE ? this.allDatabaseResults.OUTRE.length : 0,
          allResultsSNG: this.allDatabaseResults.SNG ? this.allDatabaseResults.SNG.length : 0
        });

        // 선택된 키워드가 없으면 전체 DB 표시
        if (this.selectedKeywordsList.length === 0) {
          var allOutre = this.allDatabaseResults.OUTRE || [];
          var allSng = this.allDatabaseResults.SNG || [];
          this.keywordResults = {
            OUTRE: allOutre,
            SNG: allSng
          };
          this.renderKeywordTabs();
          var allResults = allOutre.concat(allSng);
          this.renderKeywordResults(allResults);
          return;
        }

        // 회사 필터링 체크 (OUTRE/SNG 키워드 포함 여부)
        var hasOUTREKeyword = this.selectedKeywordsList.indexOf('OUTRE') > -1;
        var hasSNGKeyword = this.selectedKeywordsList.indexOf('SNG') > -1;

        // 회사명을 제외한 나머지 키워드
        var contentKeywords = [];
        for (var i = 0; i < this.selectedKeywordsList.length; i++) {
          var kw = this.selectedKeywordsList[i];
          if (kw !== 'OUTRE' && kw !== 'SNG') {
            contentKeywords.push(kw);
          }
        }

        var filteredResults = [];

        // OUTRE 검색 (OUTRE 키워드가 선택되어 있거나, 두 회사 모두 선택 해제된 경우)
        if (hasOUTREKeyword || (!hasOUTREKeyword && !hasSNGKeyword)) {
          if (this.allDatabaseResults.OUTRE) {
            filteredResults = filteredResults.concat(
              this.filterByKeywords(this.allDatabaseResults.OUTRE, contentKeywords)
            );
          }
        }

        // SNG 검색 (SNG 키워드가 선택되어 있거나, 두 회사 모두 선택 해제된 경우)
        if (hasSNGKeyword || (!hasOUTREKeyword && !hasSNGKeyword)) {
          if (this.allDatabaseResults.SNG) {
            filteredResults = filteredResults.concat(
              this.filterByKeywords(this.allDatabaseResults.SNG, contentKeywords)
            );
          }
        }

        console.log('필터링 결과', { count: filteredResults.length });

        // 회사별로 결과 저장 (탭 개수 업데이트용)
        var outreResults = [];
        var sngResults = [];
        for (var i = 0; i < filteredResults.length; i++) {
          if (filteredResults[i].company === 'OUTRE') {
            outreResults.push(filteredResults[i]);
          } else if (filteredResults[i].company === 'SNG') {
            sngResults.push(filteredResults[i]);
          }
        }

        // keywordResults에 저장 (탭 개수 표시용)
        this.keywordResults = {
          OUTRE: outreResults,
          SNG: sngResults
        };

        // 탭 개수 업데이트
        this.renderKeywordTabs();

        // 필터링된 결과로 렌더링
        this.renderKeywordResults(filteredResults);
      },

      // 키워드로 제품 필터링
      filterByKeywords: function (products, keywords) {
        if (keywords.length === 0) {
          return products;
        }

        var filtered = [];
        for (var i = 0; i < products.length; i++) {
          var item = products[i];
          var itemName = (item.itemName || '').toUpperCase();

          // 모든 키워드가 제품명에 포함되어 있는지 확인
          var matchesAll = true;
          for (var j = 0; j < keywords.length; j++) {
            var keyword = keywords[j].toUpperCase();
            if (itemName.indexOf(keyword) === -1) {
              matchesAll = false;
              break;
            }
          }

          if (matchesAll) {
            filtered.push(item);
          }
        }

        return filtered;
      },

      // ========================================
      // 예상 가격 업데이트 (현재 제품 + 장바구니 전체)
      // ========================================
      applyEstimatedPriceText: function (total) {
        var priceEl = document.getElementById('estimatedPrice');
        var priceResultsEl = document.getElementById('estimatedPriceResults');
        var safeTotal = isNaN(total) ? 0 : total;
        var priceText = '$' + safeTotal.toFixed(2);

        if (priceEl) {
          priceEl.textContent = priceText;
        }
        if (priceResultsEl) {
          priceResultsEl.textContent = priceText;
        }
      },

      setCartTotal: function (company, total) {
        if (!company) return;
        if (!this.cartTotals) {
          this.cartTotals = { OUTRE: null, SNG: null };
        }
        this.cartTotals[company] = total;
        if (this.currentCompany === company) {
          this.updateEstimatedPrice({ useCacheOnly: true });
        }
      },

      refreshCartTotal: function (company) {
        if (!company) return;
        this.loadOrderData(company);
      },

      updateEstimatedPrice: function (options) {
        console.log('updateEstimatedPrice 호출됨', {
          currentCompany: this.currentCompany,
          productsCount: this.products ? this.products.length : 0
        });

        var priceEl = document.getElementById('estimatedPrice');
        var priceResultsEl = document.getElementById('estimatedPriceResults');

        console.log('가격 요소 찾기', {
          priceEl: !!priceEl,
          priceResultsEl: !!priceResultsEl
        });

        // 현재 회사가 없으면 숨김
        if (!this.currentCompany) {
          console.log('회사 정보 없음 - 가격 표시 숨김');
          if (priceEl) {
            priceEl.classList.remove('visible', 'outre', 'sng');
            priceEl.style.display = 'none';
          }
          if (priceResultsEl) {
            priceResultsEl.classList.remove('visible', 'outre', 'sng');
            priceResultsEl.style.display = 'none';
          }
          return;
        }

        // 회사별 스타일 적용
        var companyClass = this.currentCompany === 'OUTRE' ? 'outre' : 'sng';

        if (priceEl) {
          priceEl.classList.add('visible');
          priceEl.classList.remove('outre', 'sng');
          priceEl.classList.add(companyClass);
          priceEl.style.display = 'block';
        }

        if (priceResultsEl) {
          priceResultsEl.classList.add('visible');
          priceResultsEl.classList.remove('outre', 'sng');
          priceResultsEl.classList.add(companyClass);
          priceResultsEl.style.display = 'block';
        }

        function parsePrice(text) {
          if (!text) return null;
          var matches = text.match(/\$?[\d,]+(?:\.\d{1,2})?/g);
          if (!matches || matches.length === 0) return null;
          var last = matches[matches.length - 1];
          var parsed = parseFloat(last.replace(/[^0-9.]/g, ''));
          return isNaN(parsed) ? null : parsed;
        }

        var cachedTotal = this.cartTotals ? this.cartTotals[this.currentCompany] : null;
        if (cachedTotal !== null && cachedTotal !== undefined) {
          this.applyEstimatedPriceText(cachedTotal);
          return;
        }

        if (options && options.useCacheOnly) {
          return;
        }

        // 서버에서 장바구니 데이터 가져와서 합산
        var self = this;
        google.script.run
          .withSuccessHandler(function(result) {
            var cartTotal = 0;

            if (result && result.success && result.data) {
              var rows = result.data;
              var headers = rows[0] || [];
              var extPriceIdx = headers.indexOf('EXT PRICE');
              if (extPriceIdx === -1) {
                extPriceIdx = headers.indexOf('Ext Price');
              }
              var unitPriceIdx = headers.indexOf('UNIT PRICE');
              if (unitPriceIdx === -1) {
                unitPriceIdx = headers.indexOf('Unit Price');
              }
              var qtyIdx = headers.indexOf('수량');
              if (qtyIdx === -1) {
                qtyIdx = headers.indexOf('?˜ëŸ‰');
              }

              // 헤더 제외하고 데이터 행만 처리
              for (var i = 1; i < rows.length; i++) {
                var row = rows[i];
                var extPriceStr = extPriceIdx !== -1 ? (row[extPriceIdx] || '') : '';
                if (!extPriceStr && row.length > 1) {
                  extPriceStr = row[row.length - 2] || '';
                }
                var extPrice = parsePrice(extPriceStr);
                if (extPrice !== null) {
                  cartTotal += extPrice;
                  continue;
                }

                var unitPriceStr = unitPriceIdx !== -1 ? (row[unitPriceIdx] || '') : '';
                var unitPrice = parsePrice(unitPriceStr);
                var qtyValue = qtyIdx !== -1 ? row[qtyIdx] : '';
                var qty = parseFloat(qtyValue);
                if (!isNaN(unitPrice) && !isNaN(qty)) {
                  cartTotal += unitPrice * qty;
                }
              }
            }

            console.log('장바구니 데이터 수신', {
              success: result.success,
              cartTotal: cartTotal,
              rowsCount: result.data ? result.data.length : 0
            });

            self.setCartTotal(self.currentCompany, cartTotal);
            self.applyEstimatedPriceText(cartTotal);
          })
          .withFailureHandler(function(error) {
            console.error('장바구니 데이터 가져오기 실패', error);
            var fallbackTotal = self.cartTotals ? self.cartTotals[self.currentCompany] : null;
            if (fallbackTotal !== null && fallbackTotal !== undefined) {
              self.applyEstimatedPriceText(fallbackTotal);
              return;
            }
            self.applyEstimatedPriceText(0);
          })
          .getOrderData(this.currentCompany);
      }
    };

    // 앱 시작
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        app.init();
      });
    } else {
      app.init();
    }
  </script>
</body>

</html>
